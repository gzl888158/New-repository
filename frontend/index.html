<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬§æ˜“ç½‘æ ¼äº¤æ˜“æœºå™¨äºº V3.0ï¼ˆæ™ºèƒ½äº¤æ˜“æ­æ¡£ï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #121212; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; max-width: 1400px; margin: 0 auto; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #4fc3f7; display: flex; align-items: center; }
        .card-title i { margin-right: 8px; }
        .btn { border: none; border-radius: 6px; padding: 12px 20px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .btn-success { background: #4caf50; color: #fff; }
        .btn-danger { background: #f44336; color: #fff; }
        .btn-disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        .btn:hover:not(.btn-disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .margin-bottom-10 { margin-bottom: 10px; }
        .margin-bottom-15 { margin-bottom: 15px; }
        .text-success { color: #4caf50; }
        .text-danger { color: #f44336; }
        .text-warning { color: #ff9800; }
        .text-info { color: #4fc3f7; }
        .param-group { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2c2c2c; }
        .param-label { color: #bbb; }
        .param-value { font-weight: 500; }
        .tabs { display: flex; border-bottom: 1px solid #2c2c2c; margin-bottom: 15px; }
        .tab { padding: 10px 15px; cursor: pointer; color: #bbb; transition: all 0.3s; }
        .tab.active { color: #4fc3f7; border-bottom: 2px solid #4fc3f7; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .logs-container { height: 250px; overflow-y: auto; background: #2c2c2c; padding: 15px; border-radius: 8px; font-size: 14px; line-height: 1.6; }
        .log-item { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #3c3c3c; }
        .log-time { color: #888; margin-right: 8px; }
        .order-book { display: flex; flex-direction: column; gap: 5px; }
        .order-book-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; }
        .bids { color: #f44336; }
        .asks { color: #4caf50; }
        .trade-item { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; border-bottom: 1px solid #3c3c3c; }
        .trade-buy { color: #f44336; }
        .trade-sell { color: #4caf50; }
        .chart-container { height: 300px; background: #2c2c2c; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
        .select-box { background: #2c2c2c; border: 1px solid #3c3c3c; border-radius: 6px; padding: 10px 15px; color: #fff; font-size: 16px; width: 100%; max-width: 300px; }
        .backtest-result { background: #2c2c2c; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .progress-bar { height: 8px; background: #3c3c3c; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4caf50; }
        .progress-fill-negative { background: #f44336; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .flex { flex-direction: column; }
            .btn { width: 100%; margin-bottom: 10px; }
            .tabs { overflow-x: auto; }
            .tab { white-space: nowrap; }
            .param-group { flex-direction: column; gap: 5px; }
            .param-label { margin-bottom: 5px; }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="card">
        <div class="card-title">
            <<i>ğŸ“Š</</i> æœºå™¨äººæ ¸å¿ƒçŠ¶æ€
        </div>
        <div class="flex justify-between align-center margin-bottom-15">
            <div>
                <div class="param-label">å½“å‰çŠ¶æ€</div>
                <div id="robot-status" class="param-value text-warning">åŠ è½½ä¸­...</div>
            </div>
            <div>
                <div class="param-label">è´¦æˆ·æ€»èµ„é‡‘</div>
                <div id="total-funds" class="param-value">-- USDT</div>
            </div>
            <div>
                <div class="param-label">æ€»æ”¶ç›Šç‡</div>
                <div id="total-return" class="param-value">--%</div>
            </div>
        </div>

        <!-- å¸ç§é€‰æ‹©ä¸ç­–ç•¥æ§åˆ¶ -->
        <div class="flex gap-15 align-center margin-bottom-15">
            <div>
                <div class="param-label">é€‰æ‹©äº¤æ˜“å¸ç§</div>
                <select id="coin-select" class="select-box">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
            </div>
            <div class="flex gap-10">
                <button id="start-btn" class="btn btn-success">å¯åŠ¨ç­–ç•¥</button>
                <button id="stop-btn" class="btn btn-danger btn-disabled">åœæ­¢ç­–ç•¥</button>
            </div>
        </div>

        <!-- æ ¸å¿ƒå‚æ•°æ˜¾ç¤º -->
        <div class="flex flex-wrap gap-15 margin-bottom-10">
            <div style="flex: 1; min-width: 150px;">
                <div class="param-label">å½“å‰æ æ†</div>
                <div id="current-leverage" class="param-value">-- å€</div>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <div class="param-label">å½“å‰è¶‹åŠ¿</div>
                <div id="current-trend" class="param-value">--</div>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <div class="param-label">RSIæŒ‡æ ‡</div>
                <div id="current-rsi" class="param-value">--</div>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <div class="param-label">çˆ†ä»“é£é™©</div>
                <div id="liquidation-risk" class="param-value text-success">å®‰å…¨</div>
            </div>
        </div>
    </div>

    <!-- è¡Œæƒ…ä¸äº¤æ˜“æ•°æ®æ ‡ç­¾é¡µ -->
    <div class="card">
        <div class="card-title">
            <<i>ğŸ“ˆ</</i> å®æ—¶è¡Œæƒ…ä¸äº¤æ˜“æ•°æ®
        </div>
        <div class="tabs">
            <div class="tab active" data-tab="market">è¡Œæƒ…æ¦‚è§ˆ</div>
            <div class="tab" data-tab="order-book">ç›˜å£æ·±åº¦</div>
            <div class="tab" data-tab="trades">æˆäº¤æ˜ç»†</div>
            <div class="tab" data-tab="backtest">ç­–ç•¥å›æµ‹</div>
        </div>

        <!-- è¡Œæƒ…æ¦‚è§ˆ -->
        <div class="tab-content active" id="market-tab">
            <div class="chart-container">
                <canvas id="price-chart"></canvas> <!-- 1åˆ†é’ŸKçº¿å›¾å ä½ -->
            </div>
            <div class="flex flex-wrap gap-15">
                <div style="flex: 1; min-width: 120px;">
                    <div class="param-label">æœ€æ–°ä»·æ ¼</div>
                    <div id="latest-price" class="param-value">-- USDT</div>
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <div class="param-label">24hæœ€é«˜</div>
                    <div id="24h-high" class="param-value">-- USDT</div>
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <div class="param-label">24hæœ€ä½</div>
                    <div id="24h-low" class="param-value">-- USDT</div>
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <div class="param-label">24hæ³¢åŠ¨ç‡</div>
                    <div id="24h-volatility" class="param-value">--%</div>
                </div>
            </div>
        </div>

        <!-- ç›˜å£æ·±åº¦ -->
        <div class="tab-content" id="order-book-tab">
            <div class="order-book">
                <div class="param-label text-info">å–å•ï¼ˆå–ä¸€åˆ°å–äº”ï¼‰</div>
                <div id="asks-container" class="order-book-row asks">åŠ è½½ä¸­...</div>
                <div style="height: 10px;"></div>
                <div class="param-label text-info">ä¹°å•ï¼ˆä¹°ä¸€åˆ°ä¹°äº”ï¼‰</div>
                <div id="bids-container" class="order-book-row bids">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- æˆäº¤æ˜ç»† -->
        <div class="tab-content" id="trades-tab">
            <div id="trades-container" style="height: 300px; overflow-y: auto;">
                <div class="trade-item">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ç­–ç•¥å›æµ‹ -->
        <div class="tab-content" id="backtest-tab">
            <div class="flex gap-15 margin-bottom-15">
                <div>
                    <div class="param-label">ç½‘æ ¼å±‚æ•°</div>
                    <select id="backtest-grid-levels" class="select-box" style="max-width: 150px;">
                        <option value="5">5å±‚</option>
                        <option value="8">8å±‚</option>
                        <option value="10">10å±‚</option>
                    </select>
                </div>
                <div>
                    <div class="param-label">ATRå€ç‡</div>
                    <select id="backtest-atr-multi" class="select-box" style="max-width: 150px;">
                        <option value="1.2">1.2å€</option>
                        <option value="1.5">1.5å€</option>
                        <option value="1.8">1.8å€</option>
                    </select>
                </div>
                <button id="run-backtest-btn" class="btn btn-success" style="align-self: flex-end;">è¿è¡Œå›æµ‹</button>
            </div>
            <div class="backtest-result" id="backtest-result">
                <div class="param-label">å›æµ‹ç»“æœï¼ˆæœ€è¿‘30å¤©ï¼‰</div>
                <div class="margin-bottom-10">ç‚¹å‡»ä¸Šæ–¹"è¿è¡Œå›æµ‹"æŸ¥çœ‹ç»“æœ</div>
            </div>
        </div>
    </div>

    <!-- ç­–ç•¥è¿è¡Œæ—¥å¿— -->
    <div class="card">
        <div class="card-title">
            <<i>ğŸ“</</i> è¿è¡Œæ—¥å¿—ï¼ˆæœ€è¿‘50æ¡ï¼‰
        </div>
        <div id="logs-container" class="logs-container">
            <div class="log-item">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // åç«¯æ¥å£åœ°å€ï¼ˆæœ¬åœ°è¿è¡Œé»˜è®¤127.0.0.1:8000ï¼‰
        const API_BASE = "http://127.0.0.1:8000";

        // å…¨å±€çŠ¶æ€
        let currentCoin = "";
        let priceChart = null; // Kçº¿å›¾å®ä¾‹
        let marketDataInterval = null; // è¡Œæƒ…æ•°æ®åˆ·æ–°å®šæ—¶å™¨

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = async function() {
            try {
                // 1. åˆå§‹åŒ–åŸºç¡€æ•°æ®ï¼ˆAPIçŠ¶æ€ã€å¸ç§åˆ—è¡¨ï¼‰
                await initBaseData();
                // 2. åˆå§‹åŒ–æ ‡ç­¾é¡µåˆ‡æ¢
                initTabs();
                // 3. åˆå§‹åŒ–Kçº¿å›¾
                initPriceChart();
                // 4. åŠ è½½è¿è¡Œæ—¥å¿—
                loadLogs();
                // 5. å®šæ—¶åˆ·æ–°æ•°æ®ï¼ˆæ—¥å¿—ã€è¡Œæƒ…ï¼‰
                setInterval(loadLogs, 5000);
            } catch (err) {
                updateLog(`åˆå§‹åŒ–å¤±è´¥ï¼š${err.message}`, "error");
                document.getElementById("robot-status").textContent = "åˆå§‹åŒ–å¤±è´¥";
                document.getElementById("robot-status").className = "param-value text-danger";
            }
        };

        // åˆå§‹åŒ–åŸºç¡€æ•°æ®ï¼ˆAPIçŠ¶æ€ã€å¸ç§åˆ—è¡¨ï¼‰
        async function initBaseData() {
            // è·å–APIçŠ¶æ€
            const apiRes = await fetch(`${API_BASE}/get_api_status`);
            if (!apiRes.ok) throw new Error("åç«¯æœåŠ¡æœªå“åº”");
            const apiData = await apiRes.json();
            if (apiData.status !== "success") throw new Error(apiData.msg);

            // æ›´æ–°è´¦æˆ·æ€»èµ„é‡‘
            document.getElementById("total-funds").textContent = `${apiData.total_funds.toFixed(2)} USDT`;

            // è·å–å¸ç§åˆ—è¡¨
            const coinRes = await fetch(`${API_BASE}/get_coin_list`);
            const coinData = await coinRes.json();
            const coinSelect = document.getElementById("coin-select");
            coinSelect.innerHTML = "";

            // å¡«å……å¸ç§ä¸‹æ‹‰æ¡†
            coinData.coins.forEach(coin => {
                const option = document.createElement("option");
                option.value = coin.instId;
                option.textContent = `${coin.instId}ï¼ˆèµ„é‡‘å æ¯”ï¼š${(coin.weight*100).toFixed(0)}%ï¼‰`;
                if (coin.instId === coinData.current_coin) {
                    option.selected = true;
                    currentCoin = coin.instId;
                }
                coinSelect.appendChild(option);
            });

            // ç›‘å¬å¸ç§åˆ‡æ¢
            coinSelect.addEventListener("change", function() {
                currentCoin = this.value;
                // åˆ‡æ¢å¸ç§ååˆ·æ–°è¡Œæƒ…æ•°æ®
                if (marketDataInterval) clearInterval(marketDataInterval);
                if (currentCoin) {
                    loadMarketData(currentCoin);
                    marketDataInterval = setInterval(() => loadMarketData(currentCoin), 3000);
                }
            });

            // åˆå§‹åŒ–å½“å‰å¸ç§çš„è¡Œæƒ…æ•°æ®
            if (currentCoin) {
                loadMarketData(currentCoin);
                marketDataInterval = setInterval(() => loadMarketData(currentCoin), 3000);
            }

            // æ›´æ–°æœºå™¨äººçŠ¶æ€
            document.getElementById("robot-status").textContent = "å·²å°±ç»ª";
            document.getElementById("robot-status").className = "param-value text-success";
            document.getElementById("start-btn").disabled = false;
        }

        // åˆå§‹åŒ–æ ‡ç­¾é¡µ