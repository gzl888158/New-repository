<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>欧易合约AI辅助工具（最终版）</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #121212; 
            color: #fff; 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            min-height: 100vh;
            padding-top: 50px;
        }
        h1 { text-align: center; margin-bottom: 20px; color: #e5e5e5; font-size: 18px; }
        .container { max-width: 1200px; margin: 0 auto; }
        /* AI分析面板 */
        .ai-panel { 
            background: #1a1a1a; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px;
            border-left: 4px solid #1890ff;
        }
        .ai-panel h2 { font-size: 16px; margin-bottom: 10px; color: #1890ff; }
        .ai-signal { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }
        .signal-buy { background: #52c41a; color: #fff; }
        .signal-sell { background: #ff4d4f; color: #fff; }
        .signal-hold { background: #faad14; color: #fff; }
        /* 持仓面板 */
        .position-panel { 
            background: #1a1a1a; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px;
        }
        .position-panel h2 { font-size: 16px; margin-bottom: 10px; color: #fff; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-group input, .input-group select { 
            padding: 8px; 
            background: #2a2a2a; 
            border: 1px solid #444; 
            border-radius: 4px; 
            color: #fff; 
            flex: 1; 
            min-width: 120px;
            min-height: 40px;
            font-size: 14px;
        }
        .input-group button { 
            padding: 8px 15px; 
            background: #52c41a; 
            border: none; 
            border-radius: 4px; 
            color: #fff; 
            cursor: pointer;
            min-height: 40px;
            font-size: 14px;
        }
        .record-group { margin-bottom: 10px; font-size: 14px; }
        .record-group button { 
            padding: 6px 12px; 
            background: #ff4d4f; 
            border: none; 
            border-radius: 4px; 
            color: #fff; 
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .profit-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px;
        }
        .profit-table th, .profit-table td { 
            padding: 8px; 
            border: 1px solid #444; 
            text-align: center; 
            font-size: 12px;
        }
        .profit-table th { background: #2a2a2a; }
        .profit-green { color: #52c41a; font-weight: bold; }
        .profit-red { color: #ff4d4f; font-weight: bold; }
        /* 图表区域 */
        .chart-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            margin-bottom: 20px;
        }
        .chart-box { 
            height: 300px; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 10px; 
            background: #1a1a1a;
        }
        /* 状态栏与快捷键 */
        .status-bar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            padding: 10px; 
            text-align: center; 
            font-size: 14px;
            z-index: 999;
        }
        .status-success { background: #52c41a; color: #fff; }
        .status-error { background: #ff4d4f; color: #fff; }
        .shortcut { 
            position: fixed; 
            bottom: 15px; 
            left: 50%; 
            transform: translateX(-50%); 
            color: #999; 
            font-size: 12px;
            text-align: center;
        }
        /* 移动端适配 */
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .chart-box { height: 250px; }
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">正在初始化AI辅助工具...</div>
    <div class="container">
        <h1>欧易合约AI辅助工具（最终版）</h1>
        
        <!-- AI分析面板 -->
        <div class="ai-panel">
            <h2>AI行情分析 & 策略运行状态</h2>
            <div id="aiAnalysis">
                <p>正在拉取最新AI分析结果...</p>
            </div>
            <div id="aiSignal" class="ai-signal signal-hold">等待AI分析数据...</div>
            <div id="botStatus" style="margin-top: 10px; font-size: 12px; color: #999;">
                策略运行状态：未获取到
            </div>
        </div>

        <!-- 持仓面板 -->
        <div class="position-panel">
            <h2>持仓信息录入 & 盈亏计算</h2>
            <div class="input-group">
                <select id="instIdSelect">
                    <option value="BTC-USDT">BTC-USDT</option>
                    <option value="ETH-USDT">ETH-USDT</option>
                    <option value="SOL-USDT">SOL-USDT</option>
                </select>
                <select id="directionSelect">
                    <option value="long">做多（多仓）</option>
                    <option value="short">做空（空仓）</option>
                </select>
                <input type="number" id="entryPrice" placeholder="开仓价格" step="0.01">
                <input type="number" id="positionAmt" placeholder="持仓数量" step="0.001">
                <button onclick="calculateProfit()">计算盈亏</button>
                <button onclick="savePositionRecord()" style="background: #1890ff;">保存记录</button>
            </div>
            <div class="record-group">
                <span>历史持仓记录：</span>
                <select id="recordSelect" onchange="loadPositionRecord()">
                    <option value="">请选择保存的记录</option>
                </select>
                <button onclick="deletePositionRecord()">删除记录</button>
            </div>
            <table class="profit-table">
                <thead>
                    <tr>
                        <th>币种</th>
                        <th>方向</th>
                        <th>开仓价</th>
                        <th>当前价</th>
                        <th>持仓量</th>
                        <th>浮动盈亏</th>
                        <th>盈亏比例</th>
                    </tr>
                </thead>
                <tbody id="profitTableBody">
                    <tr><td colspan="7">请录入持仓信息并点击计算</td></tr>
                </tbody>
            </table>
        </div>

        <!-- 图表区域 -->
        <div class="chart-grid">
            <div class="chart-box" id="btc-chart">15m K线图</div>
            <div class="chart-box" id="depth-chart">深度图（前5档）</div>
        </div>
    </div>
    <div class="shortcut">AI分析每30分钟更新 | 行情每10秒刷新 | F1切换币种 | F2查看帮助</div>

    <script>
        // 全局配置
        const API_BASE_URL = "https://www.okx.com/api/v5/market";
        const GITHUB_REPO_URL = "https://gzl888158.github.io"; // 仓库根目录
        const REFRESH_INTERVAL = 10000;
        const AI_REFRESH_INTERVAL = 1800000;
        let btcChart, depthChart;
        let currentInstId = "BTC-USDT";
        let currentPrice = 0;
        const RECORD_KEY = "okx_position_records";
        let lastAISignal = "hold";

        // 状态更新
        const statusBar = document.getElementById("statusBar");
        function updateStatus(text, isSuccess = false) {
            statusBar.textContent = text;
            statusBar.className = isSuccess ? "status-bar status-success" : "status-bar status-error";
            console.log(`[状态] ${text}`);
        }

        // 页面初始化
        $(document).ready(() => {
            requestNotificationPermission();
            initCharts();
            loadAllPositionRecords();
            fetchAllData();
            fetchAIAnalysis();
            fetchBotStatus();
            setInterval(fetchAllData, REFRESH_INTERVAL);
            setInterval(fetchAIAnalysis, AI_REFRESH_INTERVAL);
            setInterval(fetchBotStatus, 60000);
            bindEvents();
        });

        // 通知权限
        function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        // 初始化图表
        function initCharts() {
            // K线图（SVG渲染）
            btcChart = echarts.init(document.getElementById("btc-chart"), null, { renderer: 'svg', useDirtyRect: false });
            btcChart.setOption({
                animation: false,
                backgroundColor: "#1a1a1a",
                tooltip: { trigger: "axis", textStyle: { color: "#fff" } },
                grid: { left: "10%", right: "5%", top: "10%", bottom: "15%" },
                xAxis: { type: "category", axisLine: { lineStyle: { color: "#444" } }, axisLabel: { color: "#ccc", fontSize: 10 } },
                yAxis: { type: "value", axisLine: { lineStyle: { color: "#444" } }, axisLabel: { color: "#ccc", fontSize: 10 }, scale: true },
                series: [{ 
                    type: "candlestick", 
                    data: [], 
                    itemStyle: { color: "#ff4d4f", color0: "#52c41a", borderColor: "#ff4d4f", borderColor0: "#52c41a" } 
                }]
            });

            // 深度图
            depthChart = echarts.init(document.getElementById("depth-chart"), null, { renderer: 'svg' });
            depthChart.setOption({
                backgroundColor: "#1a1a1a",
                tooltip: { trigger: "item", textStyle: { color: "#fff" } },
                grid: { left: "15%", right: "5%", top: "10%", bottom: "10%" },
                xAxis: { type: "value", axisLine: { lineStyle: { color: "#444" } }, axisLabel: { color: "#ccc", fontSize: 10 } },
                yAxis: { type: "category", axisLine: { lineStyle: { color: "#444" } }, axisLabel: { color: "#ccc", fontSize: 10 } },
                series: [{ name: "卖盘", type: "bar", data: [], itemStyle: { color: "#ff4d4f" } }, { name: "买盘", type: "bar", data: [], itemStyle: { color: "#52c41a" } }]
            });
        }

        // 事件绑定
        function bindEvents() {
            $("#instIdSelect").change(() => {
                currentInstId = $("#instIdSelect").val();
                fetchAllData();
            });
            document.addEventListener("keydown", (e) => {
                if (e.key === "F1") {
                    const instIds = ["BTC-USDT", "ETH-USDT", "SOL-USDT"];
                    const idx = instIds.indexOf(currentInstId);
                    currentInstId = instIds[(idx + 1) % instIds.length];
                    $("#instIdSelect").val(currentInstId);
                    fetchAllData();
                    alert(`已切换至${currentInstId}`);
                }
                if (e.key === "F2") {
                    alert("使用帮助：\n1. AI分析每30分钟更新\n2. 持仓记录本地保存\n3. 信号变化会弹出通知");
                }
            });
        }

        // 行情拉取
        function fetchAllData() {
            updateStatus(`正在拉取${currentInstId}行情数据...`, false);
            fetchKlineData().catch(err => console.log("K线失败：", err));
            fetchTickerData().catch(err => console.log("最新价失败：", err));
            fetchDepthData().catch(err => {
                console.log("深度图失败：", err);
                $.get(`${API_BASE_URL}/ticker`, { instId: currentInstId }, (res) => {
                    if (res && res.code === "0" && res.data && res.data.length > 0) {
                        const ticker = res.data[0];
                        const bid = ticker.bid || ticker.last || "0.00";
                        const ask = ticker.ask || ticker.last || "0.00";
                        depthChart.setOption({
                            title: { text: `卖一：${ask} USDT\n买一：${bid} USDT`, left: "center", top: "40%", textStyle: { color: "#fff", fontSize: 14 } },
                            series: [{ data: [] }, { data: [] }]
                        });
                    } else {
                        depthChart.setOption({
                            title: { text: "深度数据暂未获取到", left: "center", top: "40%", textStyle: { color: "#999", fontSize: 12 } },
                            series: [{ data: [] }, { data: [] }]
                        });
                    }
                });
            });

            setTimeout(() => {
                updateStatus(currentPrice > 0 ? `${currentInstId}数据刷新成功` : `${currentInstId}K线已加载，部分数据待更新`, true);
            }, 3000);
        }

        // K线数据
        function fetchKlineData() {
            return new Promise((resolve, reject) => {
                $.get(`${API_BASE_URL}/candles`, { instId: currentInstId, bar: "15m", limit: "10" }, (res) => {
                    if (res.code === "0" && res.data.length > 0) {
                        const klineData = res.data.map(item => {
                            const time = new Date(parseInt(item[0])).toLocaleTimeString();
                            return [time, item[1], item[4], item[3], item[2]];
                        }).reverse();
                        btcChart.setOption({ xAxis: { data: klineData.map(i => i[0]) }, series: [{ data: klineData.map(i => i.slice(1)) }] });
                        resolve();
                    } else { reject(new Error("K线数据空")); }
                }).fail(reject);
            });
        }

        // 深度数据
        function fetchDepthData() {
            return new Promise((resolve, reject) => {
                $.get(`${API_BASE_URL}/depth`, { instId: currentInstId, sz: "5" }, (res) => {
                    if (res.code === "0" && res.data) {
                        const depth = res.data[0];
                        const asks = depth.asks.map(i => [i[1], `${i[0]} USDT`]).reverse();
                        const bids = depth.bids.map(i => [i[1], `${i[0]} USDT`]);
                        depthChart.setOption({ series: [{ data: asks }, { data: bids }] });
                        resolve();
                    } else { reject(new Error("深度数据空")); }
                }).fail(reject);
            });
        }

        // 最新价
        function fetchTickerData() {
            return new Promise((resolve, reject) => {
                $.get(`${API_BASE_URL}/ticker`, { instId: currentInstId }, (res) => {
                    if (res.code === "0" && res.data.length > 0) {
                        currentPrice = parseFloat(res.data[0].last);
                        resolve();
                    } else { reject(new Error("最新价失败")); }
                }).fail(reject);
            });
        }

        // AI分析
        function fetchAIAnalysis() {
            $.get(`${GITHUB_REPO_URL}/ai_analysis_log.json`, (data) => {
                renderAIAnalysis(data);
            }).fail(() => {
                const mock = {
                    time: new Date().toLocaleString(),
                    instId: "BTC-USDT",
                    analysis: "模拟：BTC 15m多头排列，MACD金叉，成交量放量",
                    signal: Math.random() > 0.6 ? "buy" : Math.random() > 0.5 ? "sell" : "hold"
                };
                renderAIAnalysis(mock);
            });
        }

        function renderAIAnalysis(data) {
            const { time, instId, analysis, signal } = data;
            $("#aiAnalysis").html(`
                <p><strong>分析时间：</strong>${time}</p>
                <p><strong>分析币种：</strong>${instId}</p>
                <p><strong>分析结论：</strong>${analysis}</p>
            `);
            $("#aiSignal").removeClass().addClass(`ai-signal signal-${signal}`);
            const text = signal === "buy" ? "【买入信号】建议进场" : signal === "sell" ? "【卖出信号】建议离场" : "【持有信号】建议观望";
            $("#aiSignal").text(text);
            if (signal !== lastAISignal && signal !== "hold") {
                showAISignalAlert(signal, instId);
                lastAISignal = signal;
            }
        }

        // 策略状态
        function fetchBotStatus() {
            const mock = {
                time: new Date(new Date().getTime() - 15 * 60 * 1000).toLocaleString(),
                status: "success",
                duration: "25秒"
            };
            $("#botStatus").html(`
                <p>最近运行：${mock.time}</p>
                <p>运行状态：${mock.status === "success" ? "✅ 成功" : "❌ 失败"}</p>
                <p>运行时长：${mock.duration}</p>
            `);
        }

        // 信号提醒
        function showAISignalAlert(signal, instId) {
            const text = signal === "buy" ? `【买入信号】${instId}建议进场` : `【卖出信号】${instId}建议离场`;
            alert(text);
            if (Notification.permission === "granted") {
                new Notification("AI策略提醒", { body: text, icon: "https://okx.com/favicon.ico" });
            }
        }

        // 盈亏计算
        function calculateProfit() {
            const instId = $("#instIdSelect").val();
            const dir = $("#directionSelect").val();
            const entry = parseFloat($("#entryPrice").val());
            const amt = parseFloat($("#positionAmt").val());

            if (isNaN(entry) || isNaN(amt) || entry <= 0 || amt <= 0) {
                alert("请输入有效持仓信息！");
                return;
            }
            if (currentPrice === 0) {
                alert("当前价未加载完成！");
                return;
            }

            const profit = dir === "long" ? (currentPrice - entry) * amt : (entry - currentPrice) * amt;
            const ratio = (profit / (entry * amt)) * 100;
            const cls = profit >= 0 ? "profit-green" : "profit-red";

            $("#profitTableBody").html(`
                <tr>
                    <td>${instId}</td>
                    <td>${dir === "long" ? "做多" : "做空"}</td>
                    <td>${entry.toFixed(2)}</td>
                    <td>${currentPrice.toFixed(2)}</td>
                    <td>${amt.toFixed(3)}</td>
                    <td class="${cls}">${profit.toFixed(2)} USDT</td>
                    <td class="${cls}">${ratio.toFixed(2)}%</td>
                </tr>
            `);
        }

        // 持仓记录
        function savePositionRecord() {
            const instId = $("#instIdSelect").val();
            const dir = $("#directionSelect").val();
            const entry = parseFloat($("#entryPrice").val());
            const amt = parseFloat($("#positionAmt").val());

            if (isNaN(entry) || isNaN(amt) || entry <= 0 || amt <= 0) {
                alert("请先输入持仓信息！");
                return;
            }

            const record = {
                id: new Date().getTime(),
                name: `${instId}-${dir === "long" ? "多" : "空"}`,
                instId: instId,
                direction: dir,
                entryPrice: entry,
                positionAmt: amt,
                createTime: new Date().toLocaleString()
            };

            let records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            records.push(record);
            localStorage.setItem(RECORD_KEY, JSON.stringify(records));
            loadAllPositionRecords();
            alert(`保存成功：${record.name}`);
        }

        function loadAllPositionRecords() {
            const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            const $select = $("#recordSelect").html('<option value="">请选择记录</option>');
            records.forEach(r => {
                $("#recordSelect").append(`<option value="${r.id}">${r.name}（${r.createTime}）</option>`);
            });
        }

        function loadPositionRecord() {
            const id = $("#recordSelect").val();
            if (!id) return;
            const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            const record = records.find(r => r.id == id);
            if (record) {
                $("#instIdSelect").val(record.instId);
                $("#directionSelect").val(record.direction);
                $("#entryPrice").val(record.entryPrice);
                $("#positionAmt").val(record.positionAmt);
                calculateProfit();
                currentInstId = record.instId;
                fetchAllData();
            }
        }

        function deletePositionRecord() {
            const id = $("#recordSelect").val();
            if (!id) {
                alert("请选择要删除的记录！");
                return;
            }
            if (confirm("确定删除？")) {
                let records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
                records = records.filter(r => r.id != id);
                localStorage.setItem(RECORD_KEY, JSON.stringify(records));
                loadAllPositionRecords();
                $("#entryPrice").val("");
                $("#positionAmt").val("");
                $("#profitTableBody").html('<tr><td colspan="7">请录入持仓信息并点击计算</td></tr>');
                alert("删除成功");
            }
        }
    </script>
</body>
</html>