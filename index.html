<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>欧易合约实时监控（15m-4h 短线）</title>
    <!-- 引入ECharts和跨域兼容库 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #121212; 
            color: #fff; 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            min-height: 100vh;
        }
        h1 { text-align: center; margin-bottom: 20px; color: #e5e5e5; }
        .chart-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 20px; 
            margin-bottom: 30px;
        }
        .chart-box { 
            height: 400px; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 10px; 
            background: #1a1a1a;
        }
        .status-bar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            padding: 8px; 
            text-align: center; 
            font-size: 14px;
            z-index: 999;
        }
        .status-success { background: #52c41a; color: #fff; }
        .status-error { background: #ff4d4f; color: #fff; }
        .shortcut { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            color: #999; 
            font-size: 12px;
        }
        /* 适配移动端 */
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .chart-box { height: 300px; }
        }
    </style>
</head>
<body>
    <!-- 连接状态提示栏 -->
    <div class="status-bar" id="statusBar">正在连接行情服务器...</div>
    <h1>欧易合约实时监控（15m-4h 短线）</h1>
    <div class="chart-grid">
        <div class="chart-box" id="btc-chart">BTC-USDT-SWAP（15m K线）</div>
        <div class="chart-box" id="depth-chart">BTC 深度图（前5档）</div>
    </div>
    <div class="shortcut">快捷键：F1切换周期 | F2启动策略 | F3风险监控</div>

    <script>
        // 全局变量
        let ws = null;
        let reconnectTimer = null;
        const RECONNECT_INTERVAL = 5000; // 5秒重连一次
        const OKX_WS_URL = "wss://ws.okx.com/ws/v5/public"; // 兼容版地址（去掉8443端口）

        // 初始化状态提示
        const statusBar = document.getElementById("statusBar");
        function updateStatus(text, isSuccess = false) {
            statusBar.textContent = text;
            statusBar.className = isSuccess ? "status-bar status-success" : "status-bar status-error";
            console.log(`[状态] ${text}`);
        }

        // 页面加载完成后初始化图表
        document.addEventListener("DOMContentLoaded", () => {
            // 初始化BTC K线图
            const btcChart = echarts.init(document.getElementById("btc-chart"), null, { renderer: 'canvas' });
            btcChart.setOption({
                backgroundColor: "#1a1a1a",
                tooltip: { trigger: "axis", textStyle: { color: "#fff" } },
                xAxis: { 
                    type: "category", 
                    axisLine: { lineStyle: { color: "#444" } },
                    axisLabel: { color: "#ccc" }
                },
                yAxis: { 
                    type: "value", 
                    axisLine: { lineStyle: { color: "#444" } },
                    axisLabel: { color: "#ccc" }
                },
                series: [{ 
                    type: "candlestick", 
                    data: [], 
                    itemStyle: { 
                        color: "#ff4d4f", // 上涨红
                        color0: "#52c41a", // 下跌绿
                        borderColor: "#ff4d4f",
                        borderColor0: "#52c41a"
                    } 
                }]
            });

            // 初始化深度图
            const depthChart = echarts.init(document.getElementById("depth-chart"), null, { renderer: 'canvas' });
            depthChart.setOption({
                backgroundColor: "#1a1a1a",
                tooltip: { trigger: "item", textStyle: { color: "#fff" } },
                xAxis: { 
                    type: "value", 
                    axisLine: { lineStyle: { color: "#444" } },
                    axisLabel: { color: "#ccc" }
                },
                yAxis: { 
                    type: "category", 
                    axisLine: { lineStyle: { color: "#444" } },
                    axisLabel: { color: "#ccc" }
                },
                series: [
                    { name: "卖盘", type: "bar", data: [], itemStyle: { color: "#ff4d4f" } },
                    { name: "买盘", type: "bar", data: [], itemStyle: { color: "#52c41a" } }
                ]
            });

            // 连接WebSocket
            connectWebSocket();

            // 处理行情数据
            function handleWsMessage(data) {
                try {
                    const msg = JSON.parse(data);
                    console.log("[行情数据]", msg); // 控制台打印原始数据，方便排查

                    // 更新15m K线
                    if (msg.arg?.channel === "candle15m" && msg.data) {
                        const [ts, open, high, low, close] = msg.data[0];
                        const timeStr = new Date(parseInt(ts)).toLocaleTimeString();
                        btcChart.setOption({
                            xAxis: { data: [timeStr] },
                            series: [{ data: [[open, close, low, high]] }]
                        });
                    }

                    // 更新深度图（前5档）
                    if (msg.arg?.channel === "depth5" && msg.data) {
                        const asks = msg.data[0].asks.map(d => [d[1], d[0]]).reverse(); // 卖盘：量-价
                        const bids = msg.data[0].bids.map(d => [d[1], d[0]]); // 买盘：量-价
                        depthChart.setOption({
                            series: [{ data: asks }, { data: bids }]
                        });
                    }
                } catch (e) {
                    updateStatus(`数据解析错误：${e.message}`, false);
                }
            }

            // 建立WebSocket连接
            function connectWebSocket() {
                if (ws) ws.close();
                updateStatus("正在连接欧易行情服务器...", false);

                ws = new WebSocket(OKX_WS_URL);
                ws.binaryType = "blob";

                // 连接成功
                ws.onopen = () => {
                    clearTimeout(reconnectTimer);
                    updateStatus("行情服务器连接成功，正在订阅数据...", true);
                    // 订阅BTC-USDT-SWAP的15m K线和深度5档
                    ws.send(JSON.stringify({
                        op: "subscribe",
                        args: [
                            { channel: "candle15m", instId: "BTC-USDT-SWAP" },
                            { channel: "depth5", instId: "BTC-USDT-SWAP" }
                        ]
                    }));
                };

                // 接收消息
                ws.onmessage = (e) => {
                    handleWsMessage(e.data);
                };

                // 连接错误
                ws.onerror = (error) => {
                    updateStatus(`WebSocket连接错误：${error.message}`, false);
                };

                // 连接关闭
                ws.onclose = () => {
                    updateStatus("行情连接断开，5秒后自动重连...", false);
                    reconnectTimer = setTimeout(connectWebSocket, RECONNECT_INTERVAL);
                };
            }

            // 快捷键绑定
            document.addEventListener("keydown", (e) => {
                if (e.key === "F1") alert("切换K线周期：15m → 1h → 4h（即将上线）");
                if (e.key === "F2") alert("策略已启动，查看GitHub Actions日志确认执行状态");
                if (e.key === "F3") alert("保证金风险监控中，当前无异常");
            });
        });

        // 手动刷新页面时关闭重连定时器
        window.onbeforeunload = () => {
            clearTimeout(reconnectTimer);
            if (ws) ws.close();
        };
    </script>
</body>
</html>