<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欧易合约AI网格交易机器人</title>
    <style>
        body { background: #121212; color: #fff; font-family: sans-serif; padding: 20px; }
        .status-bar { text-align: center; margin-bottom: 20px; }
        .config-card, .status-card { background: #1e1e1e; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .btn { background: #e53935; border: none; color: #fff; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        .error { color: #e53935; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="status-bar">
        <h1>欧易合约AI网格交易机器人（自动登录版）</h1>
        <p id="current-status">当前状态：加载中 | 机器人停止</p>
    </div>

    <!-- 移除原API配置表单，改为自动状态同步 -->
    <div class="config-card">
        <h2>策略配置（已内置）</h2>
        <p>交易对：BTC-USDT-SWAP</p>
        <p>网格层数：5</p>
        <p>ATR倍率：1.2</p>
        <p>环境：实盘</p>
    </div>

    <div class="status-card">
        <h2>策略运行状态</h2>
        <p id="strategy-status">等待初始化...</p>
        <p>基准价：<span id="base-price">--</span> | 网格间距：<span id="grid-spacing">--</span></p>
        <p>买单档位：<span id="buy-levels">--</span> | 卖单档位：<span id="sell-levels">--</span></p>
        <button id="start-btn" class="btn" disabled>启动策略</button>
        <button id="stop-btn" class="btn" disabled>停止策略</button>
    </div>

    <div class="logs-card">
        <h2>运行日志</h2>
        <div id="logs-container" style="height: 200px; overflow-y: auto; background: #2c2c2c; padding: 10px; border-radius: 4px;"></div>
    </div>

    <script>
        // 后端接口地址（替换为你的后端IP+端口）
        const API_BASE = "http://你的后端IP:8000";

        // 页面加载后自动同步状态
        window.onload = async function() {
            try {
                // 1. 验证后端API状态
                const apiRes = await fetch(`${API_BASE}/get_api_status`);
                const apiData = await apiRes.json();
                
                if (apiData.status === "success") {
                    document.getElementById("current-status").textContent = "当前状态：已登录 | 机器人停止";
                    document.getElementById("start-btn").disabled = false;
                    document.getElementById("strategy-status").textContent = "已就绪，可启动策略";
                } else {
                    throw new Error("API自动验证失败");
                }

                // 2. 加载最新日志
                loadLogs();
            } catch (err) {
                document.getElementById("current-status").textContent = "当前状态：未登录 | 机器人停止";
                document.querySelector(".error").textContent = "错误：" + err.message;
            }
        };

        // 启动策略
        document.getElementById("start-btn").addEventListener("click", async function() {
            try {
                const res = await fetch(`${API_BASE}/start_grid`, { method: "POST" });
                const data = await res.json();
                
                if (data.status === "success") {
                    document.getElementById("current-status").textContent = "当前状态：已登录 | 机器人运行中";
                    document.getElementById("strategy-status").textContent = "策略运行中";
                    document.getElementById("base-price").textContent = data.basePrice;
                    document.getElementById("grid-spacing").textContent = data.gridSpacing;
                    document.getElementById("buy-levels").textContent = data.buyLevels.join(", ");
                    document.getElementById("sell-levels").textContent = data.sellLevels.join(", ");
                    document.getElementById("start-btn").disabled = true;
                    document.getElementById("stop-btn").disabled = false;
                    log("策略启动成功");
                }
            } catch (err) {
                log("策略启动失败：" + err.message);
            }
        });

        // 停止策略
        document.getElementById("stop-btn").addEventListener("click", async function() {
            try {
                const res = await fetch(`${API_BASE}/stop_grid`, { method: "POST" });
                const data = await res.json();
                
                if (data.status === "success") {
                    document.getElementById("current-status").textContent = "当前状态：已登录 | 机器人停止";
                    document.getElementById("strategy-status").textContent = "已就绪，可启动策略";
                    document.getElementById("start-btn").disabled = false;
                    document.getElementById("stop-btn").disabled = true;
                    log("策略停止成功");
                }
            } catch (err) {
                log("策略停止失败：" + err.message);
            }
        });

        // 加载日志
        async function loadLogs() {
            const res = await fetch(`${API_BASE}/get_logs`);
            const data = await res.json();
            const logsContainer = document.getElementById("logs-container");
            logsContainer.innerHTML = data.logs.map(log => `<div>${log}</div>`).join("");
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // 记录日志
        function log(msg) {
            const logsContainer = document.getElementById("logs-container");
            const time = new Date().toLocaleTimeString();
            logsContainer.innerHTML += `<div>[${time}] ${msg}</div>`;
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // 定时刷新日志（每5秒）
        setInterval(loadLogs, 5000);
    </script>
</body>
</html>