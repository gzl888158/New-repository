<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±†åŒ…æ­æ¡£Â·æ¬§æ˜“åˆçº¦äº¤æ˜“åŠ©æ‰‹ã€ç»ˆæç‰ˆã€‘</title>
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box;font-family: "Microsoft YaHei", sans-serif;}
        body {background-color: #121212;color: #fff;padding: 20px;max-width: 1400px;margin: 0 auto;}
        .header {text-align: center;margin-bottom: 25px;padding-bottom: 15px;border-bottom: 2px solid #27ae60;}
        .header h1 {color: #27ae60;font-size: 32px;margin-bottom: 10px;}
        .header p {color: #ccc;font-size: 14px;}
        /* é€šç”¨æ¨¡å—æ ·å¼ */
        .module {background-color: #1e1e1e;border-radius: 10px;padding: 20px;margin-bottom: 20px;border: 1px solid #333;}
        .module-title {color: #27ae60;font-size: 20px;margin-bottom: 15px;display: flex;justify-content: space-between;align-items: center;}
        .module-title small {color: #999;font-size: 12px;font-weight: normal;}
        /* æ¥å£çŠ¶æ€+åˆ·æ–°è®¾ç½® */
        .top-bar {display: grid;grid-template-columns: 2fr 1fr;gap: 20px;margin-bottom: 20px;}
        .api-status {display: flex;flex-wrap: wrap;gap: 10px;align-items: center;}
        .api-item {padding: 6px 12px;border-radius: 4px;font-size: 12px;}
        .api-online {background-color: #27ae6033;color: #27ae60;}
        .api-offline {background-color: #e74c3c33;color: #e74c3c;}
        .api-loading {background-color: #f39c1233;color: #f39c12;}
        .refresh-setting {display: flex;align-items: center;gap: 10px;}
        .refresh-setting input {width: 100px;padding: 8px;background-color: #2c2c2c;border: 1px solid #444;border-radius: 4px;color: #fff;}
        .refresh-setting button {padding: 8px 15px;background-color: #27ae60;color: #fff;border: none;border-radius: 4px;cursor: pointer;}
        /* æ¦œå•åŒºåŸŸ */
        .rank-tabs {display: flex;gap: 10px;margin-bottom: 15px;}
        .rank-tab {padding: 8px 16px;background-color: #2c2c2c;border-radius: 6px;cursor: pointer;color: #ccc;font-size: 14px;}
        .rank-tab.active {background-color: #27ae60;color: #fff;}
        .rank-list {display: grid;grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));gap: 15px;}
        .rank-card {background-color: #2c2c2c;border-radius: 8px;padding: 15px;border-left: 3px solid #27ae60;}
        .rank-num {font-size: 28px;font-weight: bold;color: #27ae60;margin-bottom: 8px;}
        .rank-coin {font-size: 18px;margin-bottom: 5px;}
        .rank-price {color: #ccc;font-size: 14px;margin-bottom: 5px;}
        .rank-change {font-size: 14px;font-weight: 500;}
        .rank-change.rise {color: #e74c3c;}
        .rank-change.fall {color: #27ae60;}
        .alert-set {margin-top: 12px;display: flex;gap: 8px;}
        .alert-set input {flex: 1;padding: 6px;background-color: #333;border: 1px solid #f39c12;border-radius: 4px;color: #fff;font-size: 12px;}
        .alert-set button {padding: 6px 12px;background-color: #f39c12;color: #fff;border: none;border-radius: 4px;cursor: pointer;font-size: 12px;}
        /* ç­–ç•¥+é£é™©åŒº */
        .strategy-risk {display: grid;grid-template-columns: 1fr 1fr;gap: 20px;}
        .form-group {margin-bottom: 12px;}
        .form-group label {display: block;font-size: 14px;color: #ccc;margin-bottom: 5px;}
        .form-group select, .form-group input {width: 100%;padding: 10px;background-color: #2c2c2c;border: 1px solid #444;border-radius: 6px;color: #fff;}
        .calc-btn {width: 100%;padding: 12px;background-color: #27ae60;color: #fff;border: none;border-radius: 6px;cursor: pointer;margin-top: 10px;font-size: 14px;}
        .result-box {margin-top: 15px;padding: 12px;background-color: #2c2c2c;border-radius: 6px;font-size: 13px;white-space: pre-wrap;line-height: 1.6;}
        /* æé†’+æ—¥å¿—åŒº */
        .alert-log {display: grid;grid-template-columns: 1fr 1fr;gap: 20px;}
        .record-list {margin-top: 15px;padding: 12px;background-color: #2c2c2c;border-radius: 6px;font-size: 12px;max-height: 180px;overflow-y: auto;line-height: 1.8;}
        .log-input {margin-top: 15px;display: flex;gap: 10px;}
        .log-input input {flex: 1;padding: 10px;background-color: #2c2c2c;border: 1px solid #444;border-radius: 6px;color: #fff;}
        .log-input button {padding: 10px 15px;background-color: #27ae60;color: #fff;border: none;border-radius: 6px;cursor: pointer;}
        /* å¤ç›˜ç»Ÿè®¡ */
        .stats-grid {display: grid;grid-template-columns: repeat(3, 1fr);gap: 15px;margin-top: 15px;}
        .stats-card {background-color: #2c2c2c;border-radius: 8px;padding: 15px;text-align: center;}
        .stats-value {font-size: 24px;font-weight: bold;color: #27ae60;margin-bottom: 5px;}
        .stats-label {font-size: 12px;color: #ccc;}
        /* å“åº”å¼é€‚é… */
        @media (max-width: 1024px) {
            .strategy-risk, .alert-log {grid-template-columns: 1fr;}
            .top-bar {grid-template-columns: 1fr;}
        }
        @media (max-width: 768px) {
            .rank-list {grid-template-columns: 1fr;}
            .stats-grid {grid-template-columns: 1fr 1fr;}
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>è±†åŒ…æ­æ¡£Â·æ¬§æ˜“åˆçº¦äº¤æ˜“åŠ©æ‰‹ã€ç»ˆæç‰ˆã€‘</h1>
        <p>å‚»ç“œå¼æ“ä½œ â†’ çœ‹æ¦œå•/è®¾æé†’/ç”Ÿç­–ç•¥/è®°æ—¥å¿— â†’ ç¨³å®šç›ˆåˆ©</p>
    </div>

    <!-- é¡¶éƒ¨ï¼šæ¥å£çŠ¶æ€+åˆ·æ–°è®¾ç½® -->
    <div class="top-bar">
        <div class="module api-status-module">
            <div class="module-title">æ¥å£çŠ¶æ€ç›‘æ§</div>
            <div class="api-status" id="api-status">
                <div class="api-item api-loading">CoinGeckoï¼šåŠ è½½ä¸­</div>
                <div class="api-item api-loading">Binanceï¼šåŠ è½½ä¸­</div>
                <div class="api-item api-loading">KuCoinï¼šåŠ è½½ä¸­</div>
                <div class="api-item api-loading">Gate.ioï¼šåŠ è½½ä¸­</div>
                <div class="api-item api-loading">CMCï¼šåŠ è½½ä¸­</div>
                <div class="api-item" style="margin-left: auto;">æ´»è·ƒæ¥å£ï¼š<span id="active-api-count">0</span>ä¸ª</div>
            </div>
        </div>
        <div class="module refresh-setting-module">
            <div class="module-title">è¡Œæƒ…åˆ·æ–°è®¾ç½®</div>
            <div class="refresh-setting">
                <input type="number" id="refresh-interval" value="3000" min="1000" placeholder="æ¯«ç§’">
                <button onclick="updateRefreshInterval()">ç«‹å³ç”Ÿæ•ˆ</button>
                <small style="color:#999;">å»ºè®®3000-5000ms</small>
            </div>
        </div>
    </div>

    <!-- æ ¸å¿ƒï¼šæ¬§æ˜“ä¸‰æ¦œTOP3 -->
    <div class="module rank-module">
        <div class="module-title">
            æ¬§æ˜“æ ¸å¿ƒå¸ç§TOP3æ¦œå•
            <small id="rank-update-time">ä¸Šæ¬¡æ›´æ–°ï¼š--:--:--</small>
        </div>
        <div class="rank-tabs">
            <div class="rank-tab active" onclick="switchRank('rise')">æ¶¨å¹…æ¦œ</div>
            <div class="rank-tab" onclick="switchRank('hot')">çƒ­é—¨æ¦œ</div>
            <div class="rank-tab" onclick="switchRank('new')">æ–°å¸æ¦œ</div>
        </div>
        <div class="rank-list" id="rank-list">
            <!-- æ•°æ®ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ç­–ç•¥ç”Ÿæˆ+é£é™©æ§åˆ¶ -->
    <div class="strategy-risk">
        <div class="module strategy-module">
            <div class="module-title">å°ç™½ç­–ç•¥ç”Ÿæˆå™¨</div>
            <div class="form-group">
                <label>é€‰æ‹©äº¤æ˜“å¸ç§</label>
                <select id="strategy-coin">
                    <option value="BTC">BTC-USDT</option>
                    <option value="ETH">ETH-USDT</option>
                    <option value="SOL">SOL-USDT</option>
                    <option value="APT">APT-USDT</option>
                    <option value="ARB">ARB-USDT</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ€»äº¤æ˜“èµ„é‡‘ï¼ˆUSDTï¼‰</label>
                <input type="number" id="strategy-capital" value="1000" placeholder="å¦‚ 1000">
            </div>
            <div class="form-group">
                <label>é€‰æ‹©äº¤æ˜“ç­–ç•¥</label>
                <select id="strategy-type">
                    <option value="tp-sl">æ­¢ç›ˆæ­¢æŸï¼ˆé»˜è®¤ï¼‰</option>
                    <option value="grid">ç½‘æ ¼äº¤æ˜“ï¼ˆéœ‡è¡ï¼‰</option>
                    <option value="break">çªç ´äº¤æ˜“ï¼ˆè¶‹åŠ¿ï¼‰</option>
                </select>
            </div>
            <button class="calc-btn" onclick="calcStrategy()">ä¸€é”®ç”Ÿæˆæ¬§æ˜“ä¸‹å•å‚æ•°</button>
            <div class="result-box" id="strategy-result">ç‚¹å‡»ç”Ÿæˆå‚æ•°ï¼Œç›´æ¥å»æ¬§æ˜“ä¸‹å•</div>
        </div>
        <div class="module risk-module">
            <div class="module-title">é£é™©æ§åˆ¶ä¿æŠ¤å™¨</div>
            <div class="form-group">
                <label>ä¿è¯é‡‘ä½¿ç”¨ç‡ï¼ˆ%ï¼‰</label>
                <input type="number" id="margin-rate" placeholder="å¦‚ 50" oninput="checkMargin()">
                <div id="margin-alert" style="margin-top:5px;font-size:12px;"></div>
            </div>
            <div class="form-group">
                <label>æ€»äº¤æ˜“èµ„é‡‘ï¼ˆUSDTï¼‰</label>
                <input type="number" id="risk-capital" value="1000" placeholder="å¦‚ 1000">
            </div>
            <button class="calc-btn" onclick="calcMaxLoss()">è®¡ç®—å•æ¬¡æœ€å¤§å¯äºé‡‘é¢</button>
            <div class="result-box" id="risk-result">ç‚¹å‡»è®¡ç®—ï¼Œæœç»çˆ†ä»“é£é™©</div>
        </div>
    </div>

    <!-- ä»·æ ¼æé†’+äº¤æ˜“æ—¥å¿— -->
    <div class="alert-log">
        <div class="module alert-module">
            <div class="module-title">
                ä»·æ ¼æé†’å†å²è®°å½•
                <button style="padding:4px 8px;background:#f39c12;border:none;border-radius:4px;color:#fff;font-size:12px;cursor:pointer;" onclick="clearAlertRecord()">æ¸…ç©º</button>
            </div>
            <div class="record-list" id="alert-record-list">æš‚æ— æé†’è®°å½•</div>
        </div>
        <div class="module log-module">
            <div class="module-title">äº¤æ˜“å¤ç›˜æ—¥å¿—</div>
            <div class="log-input">
                <input type="text" id="log-content" placeholder="æ ¼å¼ï¼šBTCå¼€å¤š èµš50U | ETHå¼€ç©º äº20U">
                <button onclick="addTradeLog()">æ·»åŠ è®°å½•</button>
            </div>
            <div class="record-list" id="trade-log-list">æš‚æ— äº¤æ˜“è®°å½•ï¼Œèµšé’±ä»è®°å½•å¼€å§‹</div>
        </div>
    </div>

    <!-- ç›ˆäºå¤ç›˜ç»Ÿè®¡ -->
    <div class="module stats-module">
        <div class="module-title">äº¤æ˜“ç›ˆäºç»Ÿè®¡</div>
        <div class="stats-grid">
            <div class="stats-card">
                <div class="stats-value" id="stats-total">0 USDT</div>
                <div class="stats-label">æ€»ç›ˆäº</div>
            </div>
            <div class="stats-card">
                <div class="stats-value" id="stats-win">0 ç¬”</div>
                <div class="stats-label">ç›ˆåˆ©æ¬¡æ•°</div>
            </div>
            <div class="stats-card">
                <div class="stats-value" id="stats-lose">0 ç¬”</div>
                <div class="stats-label">äºæŸæ¬¡æ•°</div>
            </div>
        </div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½® ==========
        const config = {
            refreshInterval: 3000, // é»˜è®¤3ç§’åˆ·æ–°
            apiTimeout: 5000,      // æ¥å£è¶…æ—¶5ç§’
            currentRank: 'rise',   // é»˜è®¤æ˜¾ç¤ºæ¶¨å¹…æ¦œ
            apiStatus: { cg: 'loading', binance: 'loading', kucoin: 'loading', gate: 'loading', cmc: 'loading' },
            priceCache: {},        // ä»·æ ¼ç¼“å­˜
            rankData: { rise: [], hot: [], new: [] }, // æ¦œå•æ•°æ®
            alertList: [],         // ä»·æ ¼æé†’åˆ—è¡¨
            alertRecord: [],       // æé†’å†å²è®°å½•
            tradeLog: [],          // äº¤æ˜“æ—¥å¿—
            stats: { total: 0, win: 0, lose: 0 } // ç›ˆäºç»Ÿè®¡
        };

        // å¸ç§æ˜ å°„è¡¨ï¼ˆæ¬§æ˜“ä¸»æµå¸ç§+æ æ†å»ºè®®ï¼‰
        const coinMap = {
            BTC: { cg: 'bitcoin', binance: 'BTCUSDT', leverage: 5 },
            ETH: { cg: 'ethereum', binance: 'ETHUSDT', leverage: 5 },
            SOL: { cg: 'solana', binance: 'SOLUSDT', leverage: 3 },
            APT: { cg: 'aptos', binance: 'APTUSDT', leverage: 3 },
            ARB: { cg: 'arbitrum', binance: 'ARBUSDT', leverage: 3 },
            AVAX: { cg: 'avalanche-2', binance: 'AVAXUSDT', leverage: 3 },
            ADA: { cg: 'cardano', binance: 'ADAUSDT', leverage: 3 },
            DOT: { cg: 'polkadot', binance: 'DOTUSDT', leverage: 3 }
        };

        // ========== æ ¸å¿ƒå·¥å…·å‡½æ•° ==========
        // å¸¦è¶…æ—¶çš„æ¥å£è¯·æ±‚
        async function fetchWithTimeout(url, options = {}, timeout = config.apiTimeout) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeout);
            try {
                const res = await fetch(url, { ...options, signal: controller.signal });
                clearTimeout(timer);
                return res.ok ? await res.json() : null;
            } catch (err) {
                clearTimeout(timer);
                return null;
            }
        }

        // è®¡ç®—æ•°å­—ä¿ç•™ä¸¤ä½å°æ•°
        function fixed2(num) {
            return parseFloat(num).toFixed(2);
        }

        // ========== è¡Œæƒ…æ•°æ®æ‹‰å–+æ›´æ–° ==========
        async function fetchAllApiData() {
            // 1. æ‹‰å–CoinGeckoæ•°æ®ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
            const cgIds = Object.values(coinMap).map(item => item.cg).join(',');
            const cgData = await fetchWithTimeout(`https://api.coingecko.com/api/v3/simple/price?ids=${cgIds}&vs_currencies=usd&include_24hr_change=true`);
            config.apiStatus.cg = cgData ? 'online' : 'offline';
            if (cgData) {
                Object.keys(cgData).forEach(cgId => {
                    const coin = Object.keys(coinMap).find(k => coinMap[k].cg === cgId);
                    if (coin) {
                        config.priceCache[coin] = {
                            price: fixed2(cgData[cgId].usd),
                            change: fixed2(cgData[cgId].usd_24h_change)
                        };
                    }
                });
            }

            // 2. æ‹‰å–Binanceæ•°æ®ï¼ˆå¤‡ç”¨ï¼‰
            const binanceSymbols = Object.values(coinMap).map(item => item.binance).join('","');
            const binanceData = await fetchWithTimeout(`https://api.binance.com/api/v3/ticker/24hr?symbols=["${binanceSymbols}"]`);
            config.apiStatus.binance = binanceData ? 'online' : 'offline';
            if (binanceData && Array.isArray(binanceData)) {
                binanceData.forEach(item => {
                    const coin = Object.keys(coinMap).find(k => coinMap[k].binance === item.symbol);
                    if (coin && !config.priceCache[coin]) {
                        config.priceCache[coin] = {
                            price: fixed2(item.lastPrice),
                            change: fixed2(item.priceChangePercent)
                        };
                    }
                });
            }

            // 3. æ›´æ–°UI
            updateApiStatusUI();
            generateRankData();
            updateRankUI();
            checkAlertPrice();
            updateStatsUI();
        }

        // ========== æ¦œå•æ•°æ®ç”Ÿæˆ ==========
        function generateRankData() {
            // æ•´ç†æ‰€æœ‰å¸ç§çš„ä»·æ ¼å’Œæ¶¨å¹…
            const allCoins = Object.keys(coinMap).map(coin => {
                const data = config.priceCache[coin] || { price: '0', change: '0' };
                return { coin, price: data.price, change: parseFloat(data.change) };
            });

            // æ¶¨å¹…æ¦œï¼ˆé™åºæ’åˆ—ï¼‰
            config.rankData.rise = allCoins.sort((a, b) => b.change - a.change).slice(0, 3);
            // çƒ­é—¨æ¦œï¼ˆBTC/ETH/SOLï¼‰
            config.rankData.hot = [
                allCoins.find(c => c.coin === 'BTC'),
                allCoins.find(c => c.coin === 'ETH'),
                allCoins.find(c => c.coin === 'SOL')
            ].filter(Boolean);
            // æ–°å¸æ¦œï¼ˆAPT/ARB/AVAXï¼‰
            config.rankData.new = [
                allCoins.find(c => c.coin === 'APT'),
                allCoins.find(c => c.coin === 'ARB'),
                allCoins.find(c => c.coin === 'AVAX')
            ].filter(Boolean);

            // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            document.getElementById('rank-update-time').textContent = `ä¸Šæ¬¡æ›´æ–°ï¼š${timeStr}`;
        }

        // ========== æ¦œå•UIæ›´æ–° ==========
        function updateRankUI() {
            const rankList = document.getElementById('rank-list');
            const data = config.rankData[config.currentRank];
            let html = '';

            data.forEach((item, index) => {
                const changeClass = item.change >= 0 ? 'rise' : 'fall';
                const changeText = item.change >= 0 ? `+${item.change}%` : `${item.change}%`;
                html += `
                    <div class="rank-card">
                        <div class="rank-num">${index + 1}</div>
                        <div class="rank-coin">${item.coin}-USDT</div>
                        <div class="rank-price">ä»·æ ¼ï¼š${item.price} USDT</div>
                        <div class="rank-change ${changeClass}">24hæ¶¨å¹…ï¼š${changeText}</div>
                        <div class="alert-set">
                            <input type="number" class="alert-tp" placeholder="æ­¢ç›ˆä»·" value="${item.price}">
                            <input type="number" class="alert-sl" placeholder="æ­¢æŸä»·" value="${item.price}">
                            <button onclick="setAlert(this)" data-coin="${item.coin}">æé†’</button>
                        </div>
                    </div>
                `;
            });

            rankList.innerHTML = html;
        }

        // ========== ä»·æ ¼æé†’åŠŸèƒ½ ==========
        function setAlert(btn) {
            const coin = btn.dataset.coin;
            const tp = parseFloat(btn.parentElement.querySelector('.alert-tp').value);
            const sl = parseFloat(btn.parentElement.querySelector('.alert-sl').value);
            
            if (!tp || !sl || tp === sl) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ­¢ç›ˆ/æ­¢æŸä»·ï¼ˆä¸¤è€…ä¸èƒ½ç›¸ç­‰ï¼‰ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥å¸ç§çš„æé†’
            const exists = config.alertList.some(item => item.coin === coin);
            if (exists) {
                alert(`å·²ä¸º${coin}è®¾ç½®è¿‡æé†’ï¼Œè¯·å…ˆåˆ é™¤æ—§æé†’ï¼`);
                return;
            }

            config.alertList.push({ coin, tp, sl });
            alert(`âœ… å·²ä¸º${coin}è®¾ç½®æé†’ï¼šæ­¢ç›ˆ${tp} USDT | æ­¢æŸ${sl} USDT`);
        }

        function checkAlertPrice() {
            config.alertList.forEach((alert, index) => {
                const coinData = config.priceCache[alert.coin];
                if (!coinData) return;

                const currentPrice = parseFloat(coinData.price);
                const now = new Date();
                const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                // è§¦å‘æ­¢ç›ˆæé†’
                if (currentPrice >= alert.tp) {
                    const msg = `ã€${timeStr}ã€‘${alert.coin} è§¦å‘æ­¢ç›ˆæé†’ï¼ç›®æ ‡ä»·ï¼š${alert.tp} â†’ å½“å‰ä»·ï¼š${currentPrice}`;
                    addAlertRecord(msg);
                    config.alertList.splice(index, 1);
                    playAlertSound();
                }

                // è§¦å‘æ­¢æŸæé†’
                if (currentPrice <= alert.sl) {
                    const msg = `ã€${timeStr}ã€‘${alert.coin} è§¦å‘æ­¢æŸæé†’ï¼ç›®æ ‡ä»·ï¼š${alert.sl} â†’ å½“å‰ä»·ï¼š${currentPrice}`;
                    addAlertRecord(msg);
                    config.alertList.splice(index, 1);
                    playAlertSound();
                }
            });
        }

        function addAlertRecord(msg) {
            config.alertRecord.unshift(msg);
            document.getElementById('alert-record-list').innerHTML = config.alertRecord.map(item => `<div>${item}</div>`).join('');
        }

        function clearAlertRecord() {
            config.alertRecord = [];
            document.getElementById('alert-record-list').textContent = 'æš‚æ— æé†’è®°å½•';
        }

        function playAlertSound() {
            const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
            audio.play().catch(err => console.log('éŸ³é¢‘æé†’å¤±è´¥ï¼š', err));
        }

        // ========== ç­–ç•¥ç”ŸæˆåŠŸèƒ½ ==========
        function calcStrategy() {
            const coin = document.getElementById('strategy-coin').value;
            const capital = parseFloat(document.getElementById('strategy-capital').value) || 1000;
            const type = document.getElementById('strategy-type').value;
            const coinData = config.priceCache[coin] || { price: '0', change: '0' };
            const price = parseFloat(coinData.price);
            const change = parseFloat(coinData.change);
            const leverage = coinMap[coin].leverage;
            const positionRate = type === 'tp-sl' ? 0.05 : type === 'grid' ? 0.1 : 0.03; // ä»“ä½æ¯”ä¾‹
            const position = fixed2(capital * positionRate); // ä¸‹å•é‡‘é¢

            if (price === 0) {
                document.getElementById('strategy-result').textContent = 'âŒ æš‚æ— è¯¥å¸ç§è¡Œæƒ…æ•°æ®ï¼Œè¯·ç­‰å¾…æ¥å£åŠ è½½ï¼';
                return;
            }

            let result = '';
            const tpRate = 4; // æ­¢ç›ˆæ¯”ä¾‹
            const slRate = 2; // æ­¢æŸæ¯”ä¾‹

            // æ­¢ç›ˆæ­¢æŸç­–ç•¥
            if (type === 'tp-sl') {
                if (change > 2) {
                    // å¤šå¤´è¶‹åŠ¿
                    const tpPrice = fixed2(price * (1 + tpRate / 100));
                    const slPrice = fixed2(price * (1 - slRate / 100));
                    result = `ã€æ¬§æ˜“${coin}å¼€å¤šå‚æ•°ã€‘
1. æ æ†å€æ•°ï¼š${leverage}å€
2. å¼€ä»“ä»·æ ¼ï¼š${price} USDT
3. æ­¢ç›ˆä»·æ ¼ï¼š${tpPrice} USDTï¼ˆ+${tpRate}%ï¼‰
4. æ­¢æŸä»·æ ¼ï¼š${slPrice} USDTï¼ˆ-${slRate}%ï¼‰
5. ä¸‹å•é‡‘é¢ï¼š${position} USDTï¼ˆæ€»èµ„é‡‘${positionRate*100}%ï¼‰
ğŸ“Œ å°ç™½æç¤ºï¼šæ¶¨å¹…è¶…2%ï¼Œå¤šå¤´è¶‹åŠ¿æ˜æ˜¾ï¼Œè½»ä»“è·Ÿè¿›ï¼`;
                } else if (change < -2) {
                    // ç©ºå¤´è¶‹åŠ¿
                    const tpPrice = fixed2(price * (1 - tpRate / 100));
                    const slPrice = fixed2(price * (1 + slRate / 100));
                    result = `ã€æ¬§æ˜“${coin}å¼€ç©ºå‚æ•°ã€‘
1. æ æ†å€æ•°ï¼š${leverage}å€
2. å¼€ä»“ä»·æ ¼ï¼š${price} USDT
3. æ­¢ç›ˆä»·æ ¼ï¼š${tpPrice} USDTï¼ˆ-${tpRate}%ï¼‰
4. æ­¢æŸä»·æ ¼ï¼š${slPrice} USDTï¼ˆ+${slRate}%ï¼‰
5. ä¸‹å•é‡‘é¢ï¼š${position} USDTï¼ˆæ€»èµ„é‡‘${positionRate*100}%ï¼‰
ğŸ“Œ å°ç™½æç¤ºï¼šè·Œå¹…è¶…2%ï¼Œç©ºå¤´è¶‹åŠ¿æ˜æ˜¾ï¼Œè½»ä»“è·Ÿè¿›ï¼`;
                } else {
                    result = `ã€${coin}å½“å‰ä¿¡å·ï¼šè§‚æœ›ã€‘
1. 24hæ¶¨å¹…ï¼š${change}%ï¼Œå¤„äºéœ‡è¡è¡Œæƒ…
2. å»ºè®®ï¼šç­‰å¾…æ¶¨å¹…/è·Œå¹…è¶…2%åå†æ“ä½œ
3. ä»“ä½å»ºè®®ï¼šä¸è¶…è¿‡æ€»èµ„é‡‘çš„3%
ğŸ“Œ å°ç™½æç¤ºï¼šéœ‡è¡è¡Œæƒ…å®¹æ˜“æ¥å›æ­¢æŸï¼Œå¤šçœ‹å°‘åŠ¨ï¼`;
                }
            }

            // ç½‘æ ¼äº¤æ˜“ç­–ç•¥ï¼ˆéœ‡è¡è¡Œæƒ…ï¼‰
            if (type === 'grid') {
                const lower = fixed2(price * 0.95);
                const upper = fixed2(price * 1.05);
                const gridCount = 5;
                const gridAmount = fixed2(capital / gridCount);
                result = `ã€${coin}ç½‘æ ¼äº¤æ˜“å‚æ•°ï¼ˆéœ‡è¡è¡Œæƒ…ï¼‰ã€‘
1. ä»·æ ¼åŒºé—´ï¼š${lower} - ${upper} USDT
2. ç½‘æ ¼æ•°é‡ï¼š${gridCount} æ ¼
3. æ¯æ ¼é‡‘é¢ï¼š${gridAmount} USDT
4. æ æ†å€æ•°ï¼š${leverage}å€ï¼ˆå»ºè®®ä½æ æ†ï¼‰
ğŸ“Œ å°ç™½æç¤ºï¼šå•è¾¹è¡Œæƒ…ç¦ç”¨ï¼è·Œç ´ä¸‹æ²¿æ­¢æŸï¼Œæ¶¨ç ´ä¸Šæ²¿æ­¢ç›ˆï¼`;
            }

            // çªç ´äº¤æ˜“ç­–ç•¥ï¼ˆè¶‹åŠ¿è¡Œæƒ…ï¼‰
            if (type === 'break') {
                const breakPrice = fixed2(price * 1.01);
                const tpPrice = fixed2(price * 1.05);
                const slPrice = fixed2(price * 0.99);
                result = `ã€${coin}çªç ´äº¤æ˜“å‚æ•°ï¼ˆè¶‹åŠ¿è¡Œæƒ…ï¼‰ã€‘
1. çªç ´ä»·æ ¼ï¼š${breakPrice} USDTï¼ˆ+1%çªç ´ï¼‰
2. æ­¢ç›ˆä»·æ ¼ï¼š${tpPrice} USDTï¼ˆ+5%ï¼‰
3. æ­¢æŸä»·æ ¼ï¼š${slPrice} USDTï¼ˆ-1%ï¼‰
4. ä¸‹å•é‡‘é¢ï¼š${position} USDTï¼ˆæ€»èµ„é‡‘${positionRate*100}%ï¼‰
ğŸ“Œ å°ç™½æç¤ºï¼šçªç ´åå›è¸©ä¸è·Œç ´å†è¿›åœºï¼Œé¿å…å‡çªç ´ï¼`;
            }

            document.getElementById('strategy-result').textContent = result;
        }

        // ========== é£é™©æ§åˆ¶åŠŸèƒ½ ==========
        function checkMargin() {
            const rate = parseFloat(document.getElementById('margin-rate').value) || 0;
            const alertEl = document.getElementById('margin-alert');

            if (rate === 0) {
                alertEl.textContent = '';
                return;
            }

            if (rate < 50) {
                alertEl.textContent = 'âœ… å®‰å…¨ï¼šä¿è¯é‡‘ä½¿ç”¨ç‡è¾ƒä½ï¼Œå¯æ­£å¸¸æ“ä½œ';
                alertEl.style.color = '#27ae60';
            } else if (rate < 70) {
                alertEl.textContent = 'âš ï¸ è­¦å‘Šï¼šä»“ä½åé‡ï¼Œå»ºè®®å‡ä»“20%';
                alertEl.style.color = '#f39c12';
            } else {
                alertEl.textContent = 'âŒ å±é™©ï¼šé©¬ä¸Šçˆ†ä»“ï¼Œç«‹å³å‡ä»“ï¼';
                alertEl.style.color = '#e74c3c';
                alert('ã€é£é™©è­¦å‘Šã€‘ä¿è¯é‡‘ä½¿ç”¨ç‡è¶…è¿‡70%ï¼Œè¯·ç«‹å³å‡ä»“ï¼');
            }
        }

        function calcMaxLoss() {
            const capital = parseFloat(document.getElementById('risk-capital').value) || 1000;
            const maxLossRate = 0.02; // å•æ¬¡æœ€å¤§äºæŸ2%
            const maxLoss = fixed2(capital * maxLossRate);

            const result = `ã€å•æ¬¡æœ€å¤§å¯äºé‡‘é¢è®¡ç®—ã€‘
1. æ€»äº¤æ˜“èµ„é‡‘ï¼š${capital} USDT
2. é£æ§æ ‡å‡†ï¼šå•æ¬¡äºæŸ â‰¤ æ€»èµ„é‡‘çš„2%
3. æœ€å¤§å¯äºé‡‘é¢ï¼š${maxLoss} USDT
ğŸ“Œ å°ç™½é“å¾‹ï¼šäºåˆ°${maxLoss} USDTç«‹å³å¹³ä»“ï¼Œç»ä¸æ‰›å•ï¼`;

            document.getElementById('risk-result').textContent = result;
        }

        // ========== äº¤æ˜“æ—¥å¿—+ç›ˆäºç»Ÿè®¡ ==========
        function addTradeLog() {
            const content = document.getElementById('log-content').value.trim();
            if (!content) return;

            // è§£ææ—¥å¿—å†…å®¹ï¼ˆæ ¼å¼ï¼šå¸ç§æ–¹å‘ èµš/äºé‡‘é¢ï¼‰
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const log = `[${dateStr}] ${content}`;
            config.tradeLog.unshift(log);

            // æ›´æ–°æ—¥å¿—UI
            document.getElementById('trade-log-list').innerHTML = config.tradeLog.map(item => `<div>${item}</div>`).join('');
            document.getElementById('log-content').value = '';

            // æ›´æ–°ç›ˆäºç»Ÿè®¡
            updateStats();
        }

        function updateStats() {
            let total = 0;
            let win = 0;
            let lose = 0;

            config.tradeLog.forEach(log => {
                const matchWin = log.match(/èµš(\d+)U/);
                const matchLose = log.match(/äº(\d+)U/);

                if (matchWin) {
                    const amount = parseFloat(matchWin[1]);
                    total += amount;
                    win++;
                } else if (matchLose) {
                    const amount = parseFloat(matchLose[1]);
                    total -= amount;
                    lose++;
                }
            });

            config.stats = { total: fixed2(total), win, lose };
            updateStatsUI();
        }

        function updateStatsUI() {
            document.getElementById('stats-total').textContent = `${config.stats.total} USDT`;
            document.getElementById('stats-win').textContent = `${config.stats.win} ç¬”`;
            document.getElementById('stats-lose').textContent = `${config.stats.lose} ç¬”`;
        }

        // ========== å…¶ä»–å·¥å…·å‡½æ•° ==========
        function switchRank(type) {
            config.currentRank = type;
            document.querySelectorAll('.rank-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.rank-tab[onclick="switchRank('${type}')"]`).classList.add('active');
            updateRankUI();
        }

        function updateApiStatusUI() {
            const apiStatusEl = document.getElementById('api-status');
            let activeCount = 0;
            let html = '';

            Object.entries(config.apiStatus).forEach(([api, status]) => {
                const text = status === 'loading' ? 'åŠ è½½ä¸­' : status === 'online' ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿';
                const cls = status === 'loading' ? 'api-loading' : status === 'online' ? 'api-online' : 'api-offline';
                html += `<div class="api-item ${cls}">${api.toUpperCase()}ï¼š${text}</div>`;
                if (status === 'online') activeCount++;
            });

            html += `<div class="api-item" style="margin-left: auto;">æ´»è·ƒæ¥å£ï¼š<span id="active-api-count">${activeCount}</span>ä¸ª</div>`;
            apiStatusEl.innerHTML = html;
        }

        function updateRefreshInterval() {
            const inputVal = parseInt(document.getElementById('refresh-interval').value) || 3000;
            config.refreshInterval = Math.max(inputVal, 1000); // æœ€ä½1ç§’
            document.getElementById('refresh-interval').value = config.refreshInterval;

            // é‡å¯å®šæ—¶å™¨
            clearInterval(window.refreshTimer);
            startRefreshTimer();
            alert(`âœ… åˆ·æ–°é—´éš”å·²æ›´æ–°ä¸º ${config.refreshInterval} æ¯«ç§’`);
        }

        function startRefreshTimer() {
            fetchAllApiData(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            window.refreshTimer = setInterval(fetchAllApiData, config.refreshInterval);
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        window.onload = function() {
            updateApiStatusUI();
            startRefreshTimer();
            updateStatsUI();
        };
    </script>
</body>
</html>