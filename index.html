<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬§æ˜“åˆçº¦AIç½‘æ ¼äº¤æ˜“æœºå™¨äººï¼ˆå¼ºåŒ–ç™»å½•ç‰ˆï¼‰</title>
    <style>
        * {margin:0;padding:0;box-sizing:border-box;font-family:"Microsoft YaHei", sans-serif;}
        body {background:#121212;color:#fff;padding:20px;}
        .header {text-align:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid #333;}
        .header h1 {font-size:24px;color:#e53e3e;margin-bottom:5px;}
        .section {background:#1e1e1e;border-radius:8px;padding:15px;margin-bottom:20px;}
        .section h3 {color:#e53e3e;margin-bottom:15px;font-size:18px;display:flex;align-items:center;gap:8px;}
        .section h3::before {content:"";width:4px;height:20px;background:#e53e3e;border-radius:2px;}
        .input-group {display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
        .input-group input, .input-group select {flex:1;min-width:200px;padding:8px 10px;background:#2d2d2d;border:1px solid #444;border-radius:4px;color:#fff;outline:none;}
        .btn {padding:8px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin-right:10px;}
        .btn-red {background:#e53e3e;color:#fff;}
        .btn-green {background:#48bb78;color:#fff;}
        .btn-gray {background:#4a5568;color:#fff;}
        .btn:disabled {background:#666;cursor:not-allowed;}
        .data-tips {background:#2d2d2d;border-radius:8px;padding:10px;margin-bottom:15px;display:none;}
        .status-bar {height:20px;background:#2d2d2d;border-radius:10px;overflow:hidden;margin-bottom:10px;}
        .status-progress {height:100%;background:#ed8936;width:0;transition:width 0.5s ease, background-color 0.5s ease;}
        .table-container {overflow-x:auto;margin-top:15px;}
        table {width:100%;border-collapse:collapse;}
        th, td {padding:8px 10px;text-align:left;border-bottom:1px solid #333;font-size:14px;}
        .chart-box {flex:1;min-width:300px;height:200px;background:#2d2d2d;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;}
        .log-container {height:200px;background:#2d2d2d;border-radius:8px;padding:10px;overflow-y:auto;margin-top:10px;font-size:12px;line-height:1.5;}
    </style>
</head>
<body>
    <div class="header">
        <h1>æ¬§æ˜“åˆçº¦AIç½‘æ ¼äº¤æ˜“æœºå™¨äººï¼ˆå¼ºåŒ–ç™»å½•ç‰ˆï¼‰</h1>
        <p>å½“å‰çŠ¶æ€ï¼š<span id="robotStatus" style="color:#f56565;">æœªç™»å½• | æœºå™¨äººåœæ­¢</span></p>
    </div>

    <!-- APIç™»å½•åŒº -->
    <div class="section">
        <h3>APIé…ç½®</h3>
        <div class="input-group">
            <input type="text" id="apiKey" placeholder="æ¬§æ˜“API Key">
            <input type="password" id="apiSecret" placeholder="API Secret">
            <input type="password" id="apiPassphrase" placeholder="Passphrase">
            <select id="tradeEnv">
                <option value="real">å®ç›˜</option>
                <option value="sim">æ¨¡æ‹Ÿç›˜</option>
            </select>
        </div>
        <div class="input-group">
            <input type="text" id="instId" placeholder="äº¤æ˜“å¯¹ï¼ˆé»˜è®¤BTC-USDT-SWAPï¼‰" value="BTC-USDT-SWAP">
            <input type="number" id="gridLevels" placeholder="ç½‘æ ¼å±‚æ•°ï¼ˆé»˜è®¤5ï¼‰" value="5">
            <input type="number" id="atrMulti" placeholder="ATRä¹˜æ•°ï¼ˆé»˜è®¤1.2ï¼‰" value="1.2">
        </div>
        <button id="loginBtn" class="btn btn-red">ç™»å½•API</button>
        <button id="logoutBtn" class="btn btn-gray" style="display:none;">ç™»å‡º</button>
        <button id="startRobotBtn" class="btn btn-green" style="display:none;">å¯åŠ¨æœºå™¨äºº</button>
        <button id="stopRobotBtn" class="btn btn-gray" style="display:none;">åœæ­¢æœºå™¨äºº</button>
        <div class="data-tips" id="dataTips"><p id="tipsContent"></p></div>
    </div>

    <!-- ç­–ç•¥çŠ¶æ€åŒº -->
    <div class="section">
        <h3>ç­–ç•¥è¿è¡ŒçŠ¶æ€</h3>
        <p id="analysisStatus">ç­‰å¾…APIç™»å½•...</p>
        <div class="status-bar"><div class="status-progress" id="analysisProgress"></div></div>
        <p>åŸºå‡†ä»·ï¼š<span id="basePrice">--</span> | ç½‘æ ¼é—´è·ï¼š<span id="gridSpacing">--</span></p>
        <p>ä¹°å•æ¡£ä½ï¼š<span id="buyLevels">--</span> | å–å•æ¡£ä½ï¼š<span id="sellLevels">--</span></p>
    </div>

    <!-- è¡Œæƒ…åŒº -->
    <div class="section">
        <h3>å®æ—¶è¡Œæƒ…</h3>
        <div class="table-container">
            <table>
                <thead><tr><th>äº¤æ˜“å¯¹</th><th>æœ€æ–°ä»·</th><th>24hæ¶¨è·Œå¹…</th><th>ATRå€¼</th></tr></thead>
                <tbody id="tickerTbody"><tr><td colspan="4" style="text-align:center;">æœªç™»å½•</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- æ—¥å¿—ç›‘æ§åŒº -->
    <div class="section">
        <h3>è¿è¡Œæ—¥å¿—ç›‘æ§</h3>
        <div class="log-container" id="logContainer">è¯·å¯åŠ¨æœºå™¨äººæŸ¥çœ‹æ—¥å¿—...</div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script>
        let isLogin = false, robotRunning = false;
        const BASE_API_URL = "http://localhost:8000";

        // å¼ºåŒ–ç‰ˆæç¤ºå‡½æ•°ï¼ˆæ”¯æŒæ¢è¡Œï¼‰
        function showTips(content, type) {
            const box = document.getElementById("dataTips");
            const text = document.getElementById("tipsContent");
            box.style.display = "block";
            text.style.color = type === "error" ? "#f56565" : type === "success" ? "#48bb78" : "#ed8936";
            const contentHtml = content.replace(/\n/g, "<br>");
            text.innerHTML = type === "loading" ? `ğŸ”„ ${contentHtml}` : contentHtml;
            if (type !== "error") {
                setTimeout(() => {
                    if (!isLogin || type === "info") return;
                    box.style.display = "none";
                }, type === "success" ? 5000 : 3000);
            }
        }

        // ç™»å½•é€»è¾‘ï¼ˆå¼ºåŒ–ç‰ˆï¼Œå«è¶…æ—¶+å¼‚å¸¸è¯Šæ–­ï¼‰
        document.getElementById("loginBtn").addEventListener("click", async () => {
            const apiKey = document.getElementById("apiKey").value.trim();
            const apiSecret = document.getElementById("apiSecret").value.trim();
            const apiPassphrase = document.getElementById("apiPassphrase").value.trim();
            const instId = document.getElementById("instId").value.trim();
            const env = document.getElementById("tradeEnv").value;
            const loginBtn = document.getElementById("loginBtn");
            const progressBar = document.getElementById("analysisProgress");

            // 1. è¾“å…¥å‰ç½®æ ¡éªŒ
            if (!apiKey) {
                showTips("è¯·å¡«å†™æ¬§æ˜“API Keyï¼", "error");
                return;
            }
            if (!apiSecret) {
                showTips("è¯·å¡«å†™æ¬§æ˜“API Secretï¼", "error");
                return;
            }
            if (!apiPassphrase) {
                showTips("è¯·å¡«å†™API Passphraseï¼", "error");
                return;
            }
            if (!instId) {
                showTips("è¯·å¡«å†™äº¤æ˜“å¯¹ï¼ˆå¦‚BTC-USDT-SWAPï¼‰ï¼", "error");
                return;
            }

            // 2. åˆå§‹åŒ–ç™»å½•çŠ¶æ€
            loginBtn.disabled = true;
            loginBtn.textContent = "ç™»å½•ä¸­...";
            showTips("æ­£åœ¨éªŒè¯APIå¹¶æ‹‰å–æ•°æ®ï¼ˆè¶…æ—¶æ—¶é—´ï¼š10ç§’ï¼‰...", "loading");
            progressBar.style.width = "30%";
            progressBar.style.backgroundColor = "#ed8936";

            // 3. 10ç§’è¯·æ±‚è¶…æ—¶æ§åˆ¶
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error("è¯·æ±‚è¶…æ—¶ï¼\nå¯èƒ½åŸå› ï¼š\n1.åç«¯æœåŠ¡æœªå¯åŠ¨\n2.ç«¯å£8000è¢«å ç”¨\n3.é˜²ç«å¢™æ‹¦æˆªåç«¯è¯·æ±‚")), 10000);
            });

            try {
                // 4. å¹¶å‘è¯·æ±‚ï¼šAPIéªŒè¯ + è¶…æ—¶æ§åˆ¶
                const res = await Promise.race([
                    fetch(`${BASE_API_URL}/verify_api`, {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({apiKey, apiSecret, apiPassphrase, instId, env})
                    }),
                    timeoutPromise
                ]);

                // 5. å“åº”çŠ¶æ€ç æ£€æŸ¥
                if (!res.ok) {
                    throw new Error(`åç«¯æœåŠ¡è¿”å›é”™è¯¯ï¼š${res.status} ${res.statusText}\nå»ºè®®æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ`);
                }

                const data = await res.json();
                progressBar.style.width = "70%";

                // 6. ä¸šåŠ¡é€»è¾‘å¼‚å¸¸è¯Šæ–­
                if (data.status !== "success") {
                    let errorMsg = data.msg;
                    // APIé”™è¯¯è‡ªåŠ¨è¯Šæ–­
                    if (errorMsg.includes("APIé”™è¯¯")) {
                        errorMsg += "\n\nå¯èƒ½åŸå› ï¼š\n1.APIå¯†é’¥/å¯†ç å¡«å†™é”™è¯¯\n2.æœªå¼€å¯åˆçº¦äº¤æ˜“æƒé™\n3.å®ç›˜APIæœªé…ç½®IPç™½åå•\n4.æ¨¡æ‹Ÿç›˜/å®ç›˜é€‰æ‹©ä¸APIä¸åŒ¹é…";
                    }
                    // ç½‘ç»œé”™è¯¯è‡ªåŠ¨è¯Šæ–­
                    if (errorMsg.includes("ç½‘ç»œè¯·æ±‚å¤±è´¥")) {
                        errorMsg += "\n\nå¯èƒ½åŸå› ï¼š\n1.åç«¯æœåŠ¡æœªå¯åŠ¨\n2.ç«¯å£8000è¢«å…¶ä»–ç¨‹åºå ç”¨\n3.æœ¬åœ°é˜²ç«å¢™æ‹¦æˆªè¯·æ±‚";
                    }
                    throw new Error(errorMsg);
                }

                // 7. ç™»å½•æˆåŠŸå¤„ç†
                isLogin = true;
                progressBar.style.width = "100%";
                progressBar.style.backgroundColor = "#48bb78";
                loginBtn.style.display = "none";
                document.getElementById("logoutBtn").style.display = "inline-block";
                document.getElementById("startRobotBtn").style.display = "inline-block";
                document.getElementById("robotStatus").style.color = "#999";
                document.getElementById("robotStatus").textContent = "å·²ç™»å½• | æœºå™¨äººæœªå¯åŠ¨";
                document.getElementById("analysisStatus").textContent = `APIéªŒè¯æˆåŠŸï¼Œè´¦æˆ·UIDï¼š${data.uid}`;
                localStorage.setItem("okx_api", JSON.stringify({apiKey, apiSecret, apiPassphrase, instId, env}));
                // å¤šè¡ŒæˆåŠŸæç¤º
                showTips(`âœ… ç™»å½•æˆåŠŸï¼\n- è´¦æˆ·UIDï¼š${data.uid}\n- ${data.ticker.instId}æœ€æ–°ä»·ï¼š${data.ticker.last} USDT\n- ATRå€¼ï¼š${data.ticker.atr}`, "success");
                // æ›´æ–°è¡Œæƒ…è¡¨æ ¼
                updateTicker(data.ticker);

            } catch (err) {
                // 8. å¼‚å¸¸å¤„ç†ï¼šæ¢å¤çŠ¶æ€+æ˜¾ç¤ºé”™è¯¯
                progressBar.style.width = "100%";
                progressBar.style.backgroundColor = "#f56565";
                showTips(`âŒ ç™»å½•å¤±è´¥ï¼š${err.message}`, "error");
                loginBtn.disabled = false;
                loginBtn.textContent = "ç™»å½•API";
            }
        });

        // ç™»å‡ºé€»è¾‘
        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("okx_api");
            location.reload();
        });

        // å¯åŠ¨æœºå™¨äººé€»è¾‘
        document.getElementById("startRobotBtn").addEventListener("click", async () => {
            if (!isLogin) {
                showTips("è¯·å…ˆå®ŒæˆAPIç™»å½•ï¼", "error");
                return;
            }
            const apiInfo = JSON.parse(localStorage.getItem("okx_api"));
            const params = {
                ...apiInfo,
                gridLevels: parseInt(document.getElementById("gridLevels").value),
                atrMulti: parseFloat(document.getElementById("atrMulti").value)
            };
            showTips("å¯åŠ¨ç½‘æ ¼ç­–ç•¥...", "loading");
            try {
                const res = await fetch(`${BASE_API_URL}/start_grid`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(params)
                });
                const data = await res.json();
                if (data.status !== "success") throw new Error(data.msg);
                robotRunning = true;
                document.getElementById("startRobotBtn").style.display = "none";
                document.getElementById("stopRobotBtn").style.display = "inline-block";
                document.getElementById("robotStatus").style.color = "#48bb78";
                document.getElementById("robotStatus").textContent = "å·²ç™»å½• | æœºå™¨äººè¿è¡Œä¸­";
                document.getElementById("basePrice").textContent = data.basePrice;
                document.getElementById("gridSpacing").textContent = data.gridSpacing;
                document.getElementById("buyLevels").textContent = data.buyLevels.join(", ");
                document.getElementById("sellLevels").textContent = data.sellLevels.join(", ");
                showTips("æœºå™¨äººå¯åŠ¨æˆåŠŸï¼å¼€å§‹ä½ä¹°é«˜å–ç½‘æ ¼äº¤æ˜“", "success");
                startLogMonitor();
            } catch (err) {
                showTips(`âŒ å¯åŠ¨å¤±è´¥ï¼š${err.message}`, "error");
            }
        });

        // åœæ­¢æœºå™¨äººé€»è¾‘
        document.getElementById("stopRobotBtn").addEventListener("click", async () => {
            try {
                const res = await fetch(`${BASE_API_URL}/stop_grid`, {method: "POST"});
                const data = await res.json();
                if (data.status !== "success") throw new Error(data.msg);
                robotRunning = false;
                document.getElementById("stopRobotBtn").style.display = "none";
                document.getElementById("startRobotBtn").style.display = "inline-block";
                document.getElementById("robotStatus").style.color = "#999";
                document.getElementById("robotStatus").textContent = "å·²ç™»å½• | æœºå™¨äººåœæ­¢";
                showTips("æœºå™¨äººå·²åœæ­¢ï¼Œæ‰€æœ‰æŒ‚å•å·²å–æ¶ˆ", "info");
            } catch (err) {
                showTips(`âŒ åœæ­¢å¤±è´¥ï¼š${err.message}`, "error");
            }
        });

        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è¡Œæƒ…è¡¨æ ¼
        function updateTicker(ticker) {
            document.getElementById("tickerTbody").innerHTML = `
                <tr>
                    <td>${ticker.instId}</td>
                    <td style="color:${ticker.change > 0 ? '#f56565' : '#48bb78'}">${ticker.last}</td>
                    <td style="color:${ticker.change > 0 ? '#f56565' : '#48bb78'}">${ticker.change}%</td>
                    <td>${ticker.atr}</td>
                </tr>
            `;
        }

        // è¾…åŠ©å‡½æ•°ï¼šå®æ—¶æ—¥å¿—ç›‘æ§
        function startLogMonitor() {
            const logBox = document.getElementById("logContainer");
            setInterval(async () => {
                try {
                    const res = await fetch(`${BASE_API_URL}/get_logs`);
                    const data = await res.json();
                    logBox.innerHTML = data.logs.join("<br>");
                    logBox.scrollTop = logBox.scrollHeight;
                } catch (err) {}
            }, 2000);
        }
    </script>
</body>
</html>