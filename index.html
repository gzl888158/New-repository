<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>豆包搭档·合约交易工具【小白终极Pro版】</title>
    <style>
        /* 欧易同源深色主题+提醒样式强化 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            background-color: #121212;
            color: #ffffff;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333333;
        }
        .header h1 {
            color: #27ae60;
            font-size: 28px;
        }
        .shortcut-tips {
            margin-top: 10px;
            font-size: 12px;
            color: #999999;
        }
        /* 核心：全局信号大字报 */
        .signal-banner {
            background: linear-gradient(90deg, #27ae60, #2c3e50);
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
        }
        .signal-banner.strong-long {background: linear-gradient(90deg, #e74c3c, #c0392b);}
        .signal-banner.strong-short {background: linear-gradient(90deg, #3498db, #2980b9);}
        .signal-banner.wait {background: linear-gradient(90deg, #f39c12, #d35400);}
        /* 核心：欧易持仓同步区 */
        .okx-position-sync {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #27ae60;
        }
        .sync-title {
            color: #27ae60;
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sync-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .sync-form input {
            flex: 1;
            min-width: 200px;
            padding: 8px;
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #444444;
            border-radius: 4px;
            font-size: 12px;
        }
        .sync-form button {
            background-color: #27ae60;
            color: #ffffff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .position-alert {
            margin-top: 10px;
            font-size: 12px;
            color: #f39c12;
        }
        .position-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #2c2c2c;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.8;
        }
        .position-item {
            padding: 5px 0;
            border-bottom: 1px dashed #444444;
        }
        .position-item .profit {color: #e74c3c;}
        .position-item .loss {color: #27ae60;}
        .position-item .highlight {color: #f39c12; font-weight: bold;}
        /* 核心：提醒记录区 */
        .alert-record-container {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #f39c12;
        }
        .alert-record-title {
            color: #f39c12;
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alert-record-title button {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .alert-record-list {
            padding: 10px;
            background-color: #2c2c2c;
            border-radius: 4px;
            max-height: 100px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.6;
        }
        .alert-record-item {
            padding: 3px 0;
            border-bottom: 1px dashed #444444;
        }
        /* 自定义币种添加区 */
        .custom-coin-add {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333333;
        }
        .add-coin-title {
            color: #27ae60;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .add-coin-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .add-coin-form input {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #444444;
            border-radius: 4px;
        }
        .add-coin-form select {
            padding: 8px;
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #444444;
            border-radius: 4px;
        }
        .add-coin-btn {
            background-color: #27ae60;
            color: #ffffff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        /* 多币种监控容器 - 持仓高亮+提醒开关 */
        .monitor-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .coin-card {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #333333;
            width: calc(25% - 15px);
            min-width: 250px;
        }
        .coin-card.long {border-color: #e74c3c;}
        .coin-card.short {border-color: #3498db;}
        .coin-card.wait {border-color: #f39c12;}
        .coin-card.has-position {border: 3px solid #f39c12; box-shadow: 0 0 10px #f39c12;}
        .coin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .coin-name {
            font-weight: bold;
            color: #27ae60;
            font-size: 18px;
        }
        .alert-switch {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #f39c12;
        }
        .alert-switch input {
            width: 30px;
            height: 16px;
            appearance: none;
            background-color: #444444;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
        }
        .alert-switch input:checked {
            background-color: #f39c12;
        }
        .alert-switch input::after {
            content: '';
            width: 12px;
            height: 12px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }
        .alert-switch input:checked::after {
            left: 16px;
        }
        .exchange-select {
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #444444;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 12px;
        }
        .coin-price {
            font-size: 22px;
            margin: 10px 0;
            color: #ffffff;
        }
        .price-change {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .rise {color: #e74c3c;}
        .fall {color: #27ae60;}
        /* 核心：欧易一键下单参数+提醒点位 */
        .okx-order-params {
            background-color: #2c2c2c;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.8;
        }
        .okx-order-params span {
            color: #27ae60;
            font-weight: bold;
        }
        .alert-price-set {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        .alert-price-set input {
            flex: 1;
            padding: 4px;
            background-color: #333333;
            color: white;
            border: 1px solid #f39c12;
            border-radius: 4px;
        }
        .kline-area {
            height: 120px;
            background-color: #2c2c2c;
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        .kline-placeholder {
            text-align: center;
            line-height: 120px;
            color: #999999;
            font-size: 12px;
        }
        .indicator-btn {
            background-color: #27ae60;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 12px;
        }
        /* 策略、风险区 - 简化输入项 */
        .strategy-risk-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .strategy-card, .risk-card {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #333333;
        }
        .card-title {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            color: #cccccc;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #444444;
            border-radius: 4px;
        }
        .calc-btn {
            background-color: #27ae60;
            color: #ffffff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .result-area {
            margin-top: 15px;
            padding: 10px;
            background-color: #2c2c2c;
            border-radius: 4px;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .ai-log-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .ai-card, .log-card {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #333333;
        }
        .ai-content {
            margin-top: 15px;
            padding: 10px;
            background-color: #2c2c2c;
            border-radius: 4px;
            min-height: 100px;
            font-size: 14px;
        }
        .log-content {
            margin-top: 15px;
            padding: 10px;
            background-color: #2c2c2c;
            border-radius: 4px;
            min-height: 100px;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .add-log-btn {
            background-color: #27ae60;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 12px;
        }
        /* 响应式适配 - 手机也能看 */
        @media (max-width: 1200px) {
            .coin-card {width: calc(33.33% - 15px);}
            .strategy-risk-container, .ai-log-container {grid-template-columns: 1fr;}
        }
        @media (max-width: 768px) {
            .coin-card {width: calc(50% - 15px);}
            .signal-banner {font-size: 20px;}
        }
        @media (max-width: 480px) {
            .coin-card {width: 100%;}
            .signal-banner {font-size: 18px;}
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>豆包搭档·合约交易工具【小白终极Pro版】</h1>
        <div class="shortcut-tips">
            小白用法：同步持仓→开提醒→等弹窗→抄参数下单 | 快捷键：F1=切换周期 F2=清空预警 F3=风险计算 F4=指标开关
        </div>
    </div>

    <!-- 核心：欧易持仓同步区（小白专用，只读权限） -->
    <div class="okx-position-sync">
        <div class="sync-title">
            <span>欧易持仓一键同步（小白必看：API只开【只读】权限，绝对安全）</span>
            <span style="font-size:12px;color:#f39c12">教程：欧易→账户→API管理→新建API→勾选【只读】</span>
        </div>
        <div class="sync-form">
            <input type="text" id="okx-api-key" placeholder="欧易API Key（只读）" autocomplete="off">
            <input type="text" id="okx-api-secret" placeholder="欧易API Secret" autocomplete="off">
            <input type="text" id="okx-api-passphrase" placeholder="欧易API Passphrase" autocomplete="off">
            <button onclick="syncOkxPosition()">一键同步持仓</button>
        </div>
        <div class="position-alert">⚠️ 小白提醒：千万别开【交易】权限，防止密钥泄露被盗！</div>
        <div class="position-container" id="position-container">
            未同步持仓 | 请输入API信息后点击同步
        </div>
    </div>

    <!-- 核心：提醒记录区 -->
    <div class="alert-record-container">
        <div class="alert-record-title">
            <span>价格提醒历史记录</span>
            <button onclick="clearAlertRecord()">清空记录</button>
        </div>
        <div class="alert-record-list" id="alert-record-list">
            暂无提醒记录
        </div>
    </div>

    <!-- 核心：交易信号大字报 -->
    <div class="signal-banner wait" id="global-signal">
        等待行情确认
    </div>

    <!-- 自定义币种添加区（一键补全映射） -->
    <div class="custom-coin-add">
        <div class="add-coin-title">自定义币种添加（输入代码如 APT/ARB，小白不用管ID）</div>
        <div class="add-coin-form">
            <input type="text" id="new-coin-code" placeholder="币种代码（如 APT）" maxlength="5">
            <input type="text" id="new-coin-id" placeholder="CoinGecko ID（留空自动补）" style="display:none">
            <select id="new-coin-exchange">
                <option>欧易</option>
                <option>币安</option>
                <option>火币</option>
            </select>
            <button class="add-coin-btn" onclick="addCustomCoin()">添加币种</button>
        </div>
    </div>

    <!-- 多币种监控容器 -->
    <div class="monitor-container" id="monitor-container">
        <!-- 默认币种：BTC-USDT -->
        <div class="coin-card wait" data-coin="BTC" data-id="bitcoin">
            <div class="coin-header">
                <span class="coin-name">BTC-USDT</span>
                <div class="alert-switch">
                    <span>提醒</span>
                    <input type="checkbox" id="alert-switch-btc" onchange="toggleAlert('BTC')">
                </div>
            </div>
            <div class="coin-price">价格：<span class="real-price">--</span> USDT</div>
            <div class="price-change fall">24h涨跌幅：<span class="real-change">--</span>%</div>
            <!-- 核心：欧易一键下单参数+提醒点位 -->
            <div class="okx-order-params">
                方向：<span id="btc-direction">观望</span> | 杠杆：<span>5倍（小白推荐）</span><br>
                止盈：<span id="btc-tp">--</span> USDT | 止损：<span id="btc-sl">--</span> USDT<br>
                仓位：<span id="btc-position">总资金的5%</span>
                <div class="alert-price-set">
                    <input type="number" id="btc-alert-tp" placeholder="止盈提醒价" readonly>
                    <input type="number" id="btc-alert-sl" placeholder="止损提醒价" readonly>
                </div>
            </div>
            <div class="kline-area">
                <div class="kline-placeholder">15m K线 · 信号自动判断</div>
            </div>
            <button class="indicator-btn" onclick="toggleIndicator(this)">F4 指标开关</button>
        </div>
        <!-- 默认币种：ETH-USDT -->
        <div class="coin-card wait" data-coin="ETH" data-id="ethereum">
            <div class="coin-header">
                <span class="coin-name">ETH-USDT</span>
                <div class="alert-switch">
                    <span>提醒</span>
                    <input type="checkbox" id="alert-switch-eth" onchange="toggleAlert('ETH')">
                </div>
            </div>
            <div class="coin-price">价格：<span class="real-price">--</span> USDT</div>
            <div class="price-change rise">24h涨跌幅：<span class="real-change">--</span>%</div>
            <div class="okx-order-params">
                方向：<span id="eth-direction">观望</span> | 杠杆：<span>5倍（小白推荐）</span><br>
                止盈：<span id="eth-tp">--</span> USDT | 止损：<span id="eth-sl">--</span> USDT<br>
                仓位：<span id="eth-position">总资金的5%</span>
                <div class="alert-price-set">
                    <input type="number" id="eth-alert-tp" placeholder="止盈提醒价" readonly>
                    <input type="number" id="eth-alert-sl" placeholder="止损提醒价" readonly>
                </div>
            </div>
            <div class="kline-area">
                <div class="kline-placeholder">15m K线 · 信号自动判断</div>
            </div>
            <button class="indicator-btn" onclick="toggleIndicator(this)">F4 指标开关</button>
        </div>
        <!-- 默认币种：SOL-USDT -->
        <div class="coin-card wait" data-coin="SOL" data-id="solana">
            <div class="coin-header">
                <span class="coin-name">SOL-USDT</span>
                <div class="alert-switch">
                    <span>提醒</span>
                    <input type="checkbox" id="alert-switch-sol" onchange="toggleAlert('SOL')">
                </div>
            </div>
            <div class="coin-price">价格：<span class="real-price">--</span> USDT</div>
            <div class="price-change fall">24h涨跌幅：<span class="real-change">--</span>%</div>
            <div class="okx-order-params">
                方向：<span id="sol-direction">观望</span> | 杠杆：<span>3倍（小白推荐）</span><br>
                止盈：<span id="sol-tp">--</span> USDT | 止损：<span id="sol-sl">--</span> USDT<br>
                仓位：<span id="sol-position">总资金的3%</span>
                <div class="alert-price-set">
                    <input type="number" id="sol-alert-tp" placeholder="止盈提醒价" readonly>
                    <input type="number" id="sol-alert-sl" placeholder="止损提醒价" readonly>
                </div>
            </div>
            <div class="kline-area">
                <div class="kline-placeholder">15m K线 · 信号自动判断</div>
            </div>
            <button class="indicator-btn" onclick="toggleIndicator(this)">F4 指标开关</button>
        </div>
    </div>

    <!-- 策略与风险控制区（简化输入） -->
    <div class="strategy-risk-container">
        <div class="strategy-card">
            <div class="card-title">
                <span>小白策略生成器</span>
                <span style="font-size:12px;color:#999">输入资金自动算仓位</span>
            </div>
            <div class="form-group">
                <label>选择币种</label>
                <select id="strategy-coin">
                    <option value="BTC">BTC-USDT</option>
                    <option value="ETH">ETH-USDT</option>
                    <option value="SOL">SOL-USDT</option>
                </select>
            </div>
            <div class="form-group">
                <label>你的总资金（USDT）</label>
                <input type="number" id="strategy-capital" placeholder="如 1000" value="1000">
            </div>
            <div class="form-group">
                <label>选择策略（小白选默认）</label>
                <select id="strategy-type">
                    <option value="tp-sl">止盈止损（小白默认）</option>
                    <option value="grid">网格交易（震荡用）</option>
                    <option value="break">突破交易（趋势用）</option>
                </select>
            </div>
            <button class="calc-btn" onclick="calcStrategy()">一键生成下单参数</button>
            <div class="result-area" id="strategy-result">点击生成参数，直接去欧易下单</div>
        </div>
        <div class="risk-card">
            <div class="card-title">
                <span>小白风险保护器</span>
                <span style="font-size:12px;color:#999">防止爆仓，自动警告</span>
            </div>
            <div class="form-group">
                <label>保证金使用率（%）</label>
                <input type="number" id="margin-rate" placeholder="如 50" oninput="checkMargin()">
                <div id="margin-alert" style="margin-top:5px;font-size:12px;color:#f39c12"></div>
            </div>
            <div class="form-group">
                <label>你的总资金（USDT）</label>
                <input type="number" id="risk-capital" placeholder="如 1000" value="1000">
            </div>
            <button class="calc-btn" onclick="calcMaxLoss()">F3 计算最大可亏金额</button>
            <div class="result-area" id="risk-result">点击计算，超过就会爆仓！</div>
        </div>
    </div>

    <!-- AI解读与交易日志（人话版） -->
    <div class="ai-log-container">
        <div class="ai-card">
            <div class="card-title">
                <span>人话版行情解读（小白必看）</span>
                <span style="font-size:12px;color:#999">每30秒自动更新</span>
            </div>
            <div class="ai-content" id="ai-analysis">
                【BTC】价格没出来，暂时观望，别下单！
                【ETH】价格没出来，暂时观望，别下单！
                【SOL】价格没出来，暂时观望，别下单！
                <br><br>
                <strong>小白提示：</strong>只做「开多」「开空」信号的币种，观望的别碰！
            </div>
        </div>
        <div class="log-card">
            <div class="card-title">
                <span>交易记录本本（记盈亏）</span>
                <span style="font-size:12px;color:#999">记下来才能赚钱</span>
            </div>
            <div class="form-group">
                <label>记录格式：币种+方向+盈亏（如 BTC开多 赚50U）</label>
                <input type="text" id="log-content" placeholder="BTC开多 赚50U">
            </div>
            <button class="add-log-btn" onclick="addTradeLog()">添加记录</button>
            <div class="log-content" id="trade-log">暂无交易记录，赚钱从记录开始！</div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // 核心：币种ID映射表（小白不用管，自动补）
        const coinIdMap={
            BTC: "bitcoin",ETH: "ethereum",SOL: "solana",
            APT: "aptos",ARB: "arbitrum",ADA: "cardano",
            DOT: "polkadot",MATIC: "polygon",AVAX: "avalanche-2"
        };
        // 全局持仓数据
        let globalPositionData = {};
        // 全局提醒开关状态
        let alertSwitchStatus = {BTC: false, ETH: false, SOL: false};
        // 全局提醒点位数据
        let alertPriceData = {BTC: {tp: 0, sl: 0}, ETH: {tp: 0, sl: 0}, SOL: {tp: 0, sl: 0}};
        // 全局提醒记录
        let alertRecordList = [];

        // 核心：交易信号判断规则（小白不用懂，直接看结果）
        function getSignal(changeRate) {
            if (changeRate > 2) return {type: "strong-long", text: "强势开多", color: "#e74c3c"};
            else if (changeRate < -2) return {type: "strong-short", text: "强势开空", color: "#3498db"};
            else return {type: "wait", text: "观望", color: "#f39c12"};
        }

        // 指标开关（简化）
        function toggleIndicator(btn) {
            const kline = btn.previousElementSibling;
            const placeholder = kline.querySelector('.kline-placeholder');
            placeholder.textContent = placeholder.textContent.includes('指标') 
                ? '15m K线 · 信号自动判断' 
                : 'MACD+RSI · 信号自动判断';
        }

        // 策略计算（小白版：直接出欧易下单参数+绑定提醒点位）
        function calcStrategy() {
            const coin = document.getElementById('strategy-coin').value;
            const capital = parseFloat(document.getElementById('strategy-capital').value) || 1000;
            const type = document.getElementById('strategy-type').value;
            const price = parseFloat(document.querySelector(`.coin-card[data-coin="${coin}"] .real-price`).textContent) || 0;
            const hasPosition = globalPositionData[coin] ? true : false;
            
            if (price === 0) {
                document.getElementById('strategy-result').textContent = "行情还没加载出来，等30秒再试！";
                return;
            }

            let result = '';
            let tpPrice = 0;
            let slPrice = 0;
            // 止盈止损（小白默认）
            if (type === 'tp-sl') {
                const tpRate = 3; // 小白默认止盈3%
                const slRate = 2; // 小白默认止损2%
                tpPrice = (price * (1 + tpRate / 100)).toFixed(2);
                slPrice = (price * (1 - slRate / 100)).toFixed(2);
                const positionRate = hasPosition ? 3 : 5; // 已有持仓加仓3%，新开仓5%
                const position = (capital * (positionRate / 100)).toFixed(2);
                const leverage = coin === 'SOL' ? 3 : 5; // SOL波动大，3倍杠杆
                const positionTip = hasPosition ? '加仓' : '新开仓';

                result = `【欧易${coin}下单参数 - 小白直接抄】
1. 操作：${positionTip} | 方向：${getSignal(parseFloat(document.querySelector(`.coin-card[data-coin="${coin}"] .real-change`).textContent)).text}
2. 杠杆：${leverage}倍（千万别加杠杆！）
3. 开仓价：${price.toFixed(2)} USDT
4. 止盈价：${tpPrice} USDT | 止损价：${slPrice} USDT
5. 下单金额：${position} USDT（总资金的${positionRate}%，别多买！）
6. 操作步骤：打开欧易→合约→${coin}USDT→限价开仓→填上面的价格→确认！`;
                
                // 绑定提醒点位
                alertPriceData[coin].tp = tpPrice;
                alertPriceData[coin].sl = slPrice;
                document.getElementById(`${coin}-alert-tp`).value = tpPrice;
                document.getElementById(`${coin}-alert-sl`).value = slPrice;
            }
            // 网格交易（震荡用）
            else if (type === 'grid') {
                const gridNum = 5; // 小白默认5格
                const range = 5; // 小白默认±5%
                const step = (price * range / 100 / gridNum).toFixed(2);
                const start = (price * (1 - range / 100)).toFixed(2);
                const end = (price * (1 + range / 100)).toFixed(2);
                result = `【欧易${coin}网格参数 - 震荡行情用】
1. 网格数量：5格 | 价格区间：${start} - ${end} USDT
2. 每格金额：${(capital / gridNum / 2).toFixed(2)} USDT（别满仓！）
3. 操作步骤：欧易→策略交易→网格交易→填上面的参数→启动！
4. 小白提示：单边行情千万别用网格，会亏哭！`;
            }
            // 突破交易（趋势用）
            else if (type === 'break') {
                const breakRate = 0.5; // 突破回踩0.5%确认
                const confirmPrice = (price * (1 - breakRate / 100)).toFixed(2);
                slPrice = (confirmPrice * 0.99).toFixed(2);
                tpPrice = (confirmPrice * 1.03).toFixed(2);
                result = `【欧易${coin}突破参数 - 趋势行情用】
1. 突破确认：价格涨到${price.toFixed(2)}后，回落到${confirmPrice}再买
2. 止盈价：${tpPrice} USDT | 止损价：${slPrice} USDT
3. 下单金额：${(capital * 0.03).toFixed(2)} USDT（总资金的3%）
4. 小白提示：没突破前千万别提前买！`;
                
                // 绑定提醒点位
                alertPriceData[coin].tp = tpPrice;
                alertPriceData[coin].sl = slPrice;
                document.getElementById(`${coin}-alert-tp`).value = tpPrice;
                document.getElementById(`${coin}-alert-sl`).value = slPrice;
            }
            document.getElementById('strategy-result').textContent = result;
        }

        // 保证金预警（小白版：强制弹窗警告）
        function checkMargin() {
            const rate = parseFloat(document.getElementById('margin-rate').value) || 0;
            const alert = document.getElementById('margin-alert');
            if (rate < 50) {
                alert.textContent = "✅ 安全！可以正常操作";
                alert.style.color = "#27ae60";
            } else if (rate < 70) {
                alert.textContent = "⚠️ 仓位偏重！赶紧减仓20%";
                alert.style.color = "#f39c12";
            } else {
                alert.textContent = "❌ 危险！马上爆仓！立即减仓！";
                alert.style.color = "#e74c3c";
                alert('【小白警告】保证金使用率超过70%，再不平仓就要爆仓了！');
            }
        }

        // 最大亏损计算（小白版：直接说能亏多少）
        function calcMaxLoss() {
            const capital = parseFloat(document.getElementById('risk-capital').value) || 1000;
            const maxLossRate = 2; // 小白最大可亏2%
            const maxLoss = (capital * maxLossRate / 100).toFixed(2);
            document.getElementById('risk-result').textContent = `【小白最大可亏金额】
1. 你的总资金：${capital} USDT
2. 单次最大能亏：${maxLoss} USDT（超过这个数就止损！）
3. 止损原则：亏到${maxLoss} USDT，立即平仓，别犹豫！`;
        }

        // 交易日志添加（简化）
        function addTradeLog() {
            const content = document.getElementById('log-content').value.trim();
            if (!content) return;
            const time = new Date().toLocaleString();
            const log = document.getElementById('trade-log');
            log.textContent = log.textContent === '暂无交易记录，赚钱从记录开始！' 
                ? `[${time}] ${content}` 
                : `${log.textContent}\n[${time}] ${content}`;
            document.getElementById('log-content').value = '';
        }

        // 自定义币种添加（小白版：自动补ID+添加提醒开关）
        function addCustomCoin() {
            const code = document.getElementById('new-coin-code').value.trim().toUpperCase();
            const exchange = document.getElementById('new-coin-exchange').value;
            if (!code) {
                alert('请输入币种代码，比如APT、ARB！');
                return;
            }
            if (document.querySelector(`.coin-card[data-coin="${code}"]`)) {
                alert(`${code}-USDT已经在列表里了！`);
                return;
            }
            // 自动补全CoinGecko ID
            const coinId = coinIdMap[code] || code.toLowerCase();
            document.getElementById('new-coin-id').value = coinId;

            // 初始化提醒状态
            alertSwitchStatus[code] = false;
            alertPriceData[code] = {tp: 0, sl: 0};

            const card = document.createElement('div');
            card.className = `coin-card wait ${globalPositionData[code] ? 'has-position' : ''}`;
            card.dataset.coin = code;
            card.dataset.id = coinId;
            // 小白默认参数：杠杆3倍，仓位3%+提醒开关
            card.innerHTML = `
                <div class="coin-header">
                    <span class="coin-name">${code}-USDT</span>
                    <div class="alert-switch">
                        <span>提醒</span>
                        <input type="checkbox" id="alert-switch-${code.toLowerCase()}" onchange="toggleAlert('${code}')">
                    </div>
                </div>
                <div class="coin-price">价格：<span class="real-price">--</span> USDT</div>
                <div class="price-change fall">24h涨跌幅：<span class="real-change">--</span>%</div>
                <div class="okx-order-params">
                    方向：<span>观望</span> | 杠杆：<span>3倍（小白推荐）</span><br>
                    止盈：<span>--</span> USDT | 止损：<span>--</span> USDT<br>
                    仓位：<span>总资金的3%</span>
                    <div class="alert-price-set">
                        <input type="number" id="${code.toLowerCase()}-alert-tp" placeholder="止盈提醒价" readonly>
                        <input type="number" id="${code.toLowerCase()}-alert-sl" placeholder="止损提醒价" readonly>
                    </div>
                </div>
                <div class="kline-area">
                    <div class="kline-placeholder">15m K线 · 信号自动判断</div>
                </div>
                <button class="indicator-btn" onclick="toggleIndicator(this)">F4 指标开关</button>
            `;
            document.getElementById('monitor-container').appendChild(card);
            document.getElementById('new-coin-code').value = '';
            fetchCoinPrice(code, card);
            // 更新策略币种选择
            const option = document.createElement('option');
            option.value = code;
            option.textContent = `${code}-USDT`;
            document.getElementById('strategy-coin').appendChild(option);
        }

        // 获取真实行情+自动判断交易信号+价格提醒监控
        async function fetchCoinPrice(coinCode, card) {
            try {
                const coinId = card ? card.dataset.id : coinIdMap[coinCode];
                const apiUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd&include_24hr_change=true`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data[coinId]) {
                    const price = data[coinId].usd.toFixed(2);
                    const change = data[coinId].usd_24h_change.toFixed(2);
                    const signal = getSignal(parseFloat(change));

                    // 更新卡片数据
                    if (card) {
                        card.querySelector('.real-price').textContent = price;
                        card.querySelector('.real-change').textContent = change;
                        card.querySelector('.price-change').className = `price-change ${change >= 0 ? 'rise' : 'fall'}`;
                        // 更新信号样式
                        card.className = `coin-card ${signal.type} ${globalPositionData[coinCode] ? 'has-position' : ''}`;
                        // 更新方向文字
                        card.querySelector('.okx-order-params span').textContent = signal.text;
                        // 更新欧易下单参数（如果已生成）
                        if (alertPriceData[coinCode].tp > 0) {
                            card.querySelector('.okx-order-params span:nth-child(3)').textContent = alertPriceData[coinCode].tp;
                            card.querySelector('.okx-order-params span:nth-child(5)').textContent = alertPriceData[coinCode].sl;
                        }
                    } else {
                        document.querySelectorAll(`.coin-card[data-coin="${coinCode}"]`).forEach(item => {
                            item.querySelector('.real-price').textContent = price;
                            item.querySelector('.real-change').textContent = change;
                            item.querySelector('.price-change').className = `price-change ${change >= 0 ? 'rise' : 'fall'}`;
                            item.className = `coin-card ${signal.type} ${globalPositionData[coinCode] ? 'has-position' : ''}`;
                        });
                    }

                    // 价格提醒监控逻辑
                    if (alertSwitchStatus[coinCode] && alertPriceData[coinCode].tp > 0 && alertPriceData[coinCode].sl > 0) {
                        const currentPrice = parseFloat(price);
                        const tpPrice = parseFloat(alertPriceData[coinCode].tp);
                        const slPrice = parseFloat(alertPriceData[coinCode].sl);

                        // 止盈提醒触发
                        if (currentPrice >= tpPrice) {
                            triggerAlert(coinCode, "止盈", tpPrice, currentPrice);
                            // 触发后自动关闭提醒，防止重复弹窗
                            alertSwitchStatus[coinCode] = false;
                            document.getElementById(`alert-switch-${coinCode.toLowerCase()}`).checked = false;
                        }
                        // 止损提醒触发
                        if (currentPrice <= slPrice) {
                            triggerAlert(coinCode, "止损", slPrice, currentPrice);
                            // 触发后自动关闭提醒，防止重复弹窗
                            alertSwitchStatus[coinCode] = false;
                            document.getElementById(`alert-switch-${coinCode.toLowerCase()}`).checked = false;
                        }
                    }

                    // 更新全局信号大字报
                    updateGlobalSignal();
                    // 更新人话版AI解读
                    updateAIAnalysis(coinCode, price, change, signal.text);
                }
            } catch (error) {
                console.log(`获取${coinCode}行情失败，用模拟数据`, error);
                const mockPrice = (Math.random() * 1000 + 100).toFixed(2);
                const mockChange = (Math.random() * 4 - 2).toFixed(2);
                const signal = getSignal(parseFloat(mockChange));
                if (card) {
                    card.querySelector('.real-price').textContent = mockPrice;
                    card.querySelector('.real-change').textContent = mockChange;
                    card.querySelector('.price-change').className = `price-change ${mockChange >= 0 ? 'rise' : 'fall'}`;
                    card.className = `coin-card ${signal.type} ${globalPositionData[coinCode] ? 'has-position' : ''}`;
                }
            }
        }

        // 更新全局信号大字报
        function updateGlobalSignal() {
            const btcChange = parseFloat(document.querySelector('.coin-card[data-coin="BTC"] .real-change').textContent) || 0;
            const ethChange = parseFloat(document.querySelector('.coin-card[data-coin="ETH"] .real-change').textContent) || 0;
            const avgChange = (btcChange + ethChange) / 2;
            const signal = getSignal(avgChange);
            const globalSignal = document.getElementById('global-signal');
            globalSignal.className = `signal-banner ${signal.type}`;
            globalSignal.textContent = `大盘信号：${signal.text}`;
        }

        // 更新人话版AI解读
        function updateAIAnalysis(coinCode, price, change, signal) {
            const aiContent = document.getElementById('ai-analysis');
            const changeNum = parseFloat(change);
            const hasPosition = globalPositionData[coinCode] ? '（你已有持仓）' : '';
            let desc = '';
            if (changeNum > 2) desc = `涨了${change}%，多头很强，赶紧跟车开多${hasPosition}！`;
            else if (changeNum < -2) desc = `跌了${change}%，空头很强，赶紧开空${hasPosition}！`;
            else desc = `涨跌不大，震荡行情，别下单${hasPosition}！`;
            
            const existing = aiContent.textContent.includes(`【${coinCode}】`) 
                ? aiContent.textContent.split(`【${coinCode}】`)[0] 
                : aiContent.textContent.split('\n\n')[0] + '\n';
            
            aiContent.textContent = `${existing}【${coinCode}】价格${price} USDT，${desc}
信号：${signal} | 操作：${signal === '观望' ? '别碰' : '去欧易抄参数下单'}
\n<strong>小白提示：</strong>只做「强势开多」「强势开空」的币种，观望的别浪费钱！`;
        }

        // 核心升级：欧易持仓同步（小白专用，只读权限）
        async function syncOkxPosition() {
            const apiKey = document.getElementById('okx-api-key').value.trim();
            const apiSecret = document.getElementById('okx-api-secret').value.trim();
            const apiPassphrase = document.getElementById('okx-api-passphrase').value.trim();
            if (!apiKey || !apiSecret || !apiPassphrase) {
                alert('请填写完整的API信息！');
                return;
            }

            try {
                // 欧易合约持仓接口（REST API v5）
                const timestamp = new Date().toISOString();
                const method = 'GET';
                const requestPath = '/api/v5/position/list';
                const queryParams = 'instType=SWAP'; // 永续合约
                const fullUrl = `https://www.okx.com${requestPath}?${queryParams}`;

                // 签名生成（欧易API要求）
                const preHash = timestamp + method + requestPath + queryParams;
                const secretKey = CryptoJS.enc.Base64.parse(apiSecret);
                const hmac = CryptoJS.HmacSHA256(preHash, secretKey);
                const signature = CryptoJS.enc.Base64.stringify(hmac);

                const response = await fetch(fullUrl, {
                    method: method,
                    headers: {
                        'OK-ACCESS-KEY': apiKey,
                        'OK-ACCESS-SIGN': signature,
                        'OK-ACCESS-TIMESTAMP': timestamp,
                        'OK-ACCESS-PASSPHRASE': apiPassphrase,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                if (data.code !== '0') {
                    alert(`同步失败：${data.msg}`);
                    return;
                }

                // 解析持仓数据
                const positions = data.data;
                globalPositionData = {};
                let positionHtml = '';
                let totalMarginRate = 0;

                if (positions.length === 0) {
                    positionHtml = '当前无持仓 | 保证金使用率：0%';
                } else {
                    positions.forEach(pos => {
                        const coin = pos.instId.split('-')[0]; // BTC-USDT-SWAP → BTC
                        const posSide = pos.posSide === 'long' ? '多仓' : '空仓';
                        const vol = pos.pos;
                        const avgPx = pos.avgPx;
                        const upl = pos.upl; // 未实现盈亏
                        const uplType = upl >= 0 ? 'profit' : 'loss';
                        globalPositionData[coin] = {posSide, vol, avgPx, upl};
                        positionHtml += `<div class="position-item">
                            <span class="highlight">${coin}</span> | ${posSide} | 持仓量：${vol} | 开仓价：${avgPx} USDT | 
                            盈亏：<span class="${uplType}">${upl >= 0 ? '+' : ''}${upl} USDT</span>
                        </div>`;
                        totalMarginRate += parseFloat(pos.mgnRate);
                    });
                    totalMarginRate = (totalMarginRate / positions.length * 100).toFixed(2);
                    positionHtml += `<div class="position-item"><strong>保证金使用率：${totalMarginRate}%</strong></div>`;
                }