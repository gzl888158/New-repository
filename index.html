<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>欧易合约监控（含持仓盈亏计算）</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #121212; 
            color: #fff; 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            min-height: 100vh;
            padding-top: 50px;
        }
        h1 { text-align: center; margin-bottom: 20px; color: #e5e5e5; font-size: 18px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .position-panel { 
            background: #1a1a1a; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px;
        }
        .position-panel h2 { font-size: 16px; margin-bottom: 10px; color: #fff; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-group input, .input-group select { 
            padding: 8px; 
            background: #2a2a2a; 
            border: 1px solid #444; 
            border-radius: 4px; 
            color: #fff; 
            flex: 1; 
            min-width: 120px;
        }
        .input-group button { 
            padding: 8px 15px; 
            background: #52c41a; 
            border: none; 
            border-radius: 4px; 
            color: #fff; 
            cursor: pointer;
        }
        .record-group { margin-bottom: 10px; }
        .record-group button { 
            padding: 6px 12px; 
            background: #ff4d4f; 
            border: none; 
            border-radius: 4px; 
            color: #fff; 
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .profit-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px;
        }
        .profit-table th, .profit-table td { 
            padding: 8px; 
            border: 1px solid #444; 
            text-align: center; 
            font-size: 12px;
        }
        .profit-table th { background: #2a2a2a; }
        .profit-green { color: #52c41a; font-weight: bold; }
        .profit-red { color: #ff4d4f; font-weight: bold; }
        .chart-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            margin-bottom: 20px;
        }
        .chart-box { 
            height: 300px; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 10px; 
            background: #1a1a1a;
        }
        .status-bar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            padding: 10px; 
            text-align: center; 
            font-size: 14px;
            z-index: 999;
        }
        .status-success { background: #52c41a; color: #fff; }
        .status-error { background: #ff4d4f; color: #fff; }
        .shortcut { 
            position: fixed; 
            bottom: 15px; 
            left: 50%; 
            transform: translateX(-50%); 
            color: #999; 
            font-size: 12px;
            text-align: center;
        }
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .chart-box { height: 250px; }
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">正在拉取行情数据...</div>
    <div class="container">
        <h1>欧易合约监控（含持仓盈亏计算）</h1>
        
        <!-- 持仓盈亏计算面板 -->
        <div class="position-panel">
            <h2>持仓信息录入 & 盈亏计算</h2>
            <div class="input-group">
                <select id="instIdSelect">
                    <option value="BTC-USDT">BTC-USDT</option>
                    <option value="ETH-USDT">ETH-USDT</option>
                    <option value="SOL-USDT">SOL-USDT</option>
                </select>
                <select id="directionSelect">
                    <option value="long">做多（多仓）</option>
                    <option value="short">做空（空仓）</option>
                </select>
                <input type="number" id="entryPrice" placeholder="开仓价格" step="0.01">
                <input type="number" id="positionAmt" placeholder="持仓数量" step="0.001">
                <button onclick="calculateProfit()">计算盈亏</button>
                <button onclick="savePositionRecord()" style="background: #1890ff;">保存记录</button>
            </div>
            <div class="record-group">
                <span>历史持仓记录：</span>
                <select id="recordSelect" onchange="loadPositionRecord()">
                    <option value="">请选择保存的记录</option>
                </select>
                <button onclick="deletePositionRecord()">删除记录</button>
            </div>
            <table class="profit-table">
                <thead>
                    <tr>
                        <th>币种</th>
                        <th>方向</th>
                        <th>开仓价</th>
                        <th>当前价</th>
                        <th>持仓量</th>
                        <th>浮动盈亏</th>
                        <th>盈亏比例</th>
                    </tr>
                </thead>
                <tbody id="profitTableBody">
                    <tr><td colspan="7">请录入持仓信息并点击计算</td></tr>
                </tbody>
            </table>
        </div>

        <!-- 行情图表区域 -->
        <div class="chart-grid">
            <div class="chart-box" id="btc-chart">15m K线图</div>
            <div class="chart-box" id="depth-chart">深度图（前5档）</div>
        </div>
    </div>
    <div class="shortcut">数据每10秒自动刷新 | F1切换币种 | F2查看策略状态</div>

    <script>
        // 全局配置
        const API_BASE_URL = "https://www.okx.com/api/v5/market";
        const REFRESH_INTERVAL = 10000;
        let btcChart, depthChart;
        let currentInstId = "BTC-USDT";
        let currentPrice = 0; // 存储当前最新价
        const RECORD_KEY = "okx_position_records"; // 本地缓存键名

        // 初始化状态提示
        const statusBar = document.getElementById("statusBar");
        function updateStatus(text, isSuccess = false) {
            statusBar.textContent = text;
            statusBar.className = isSuccess ? "status-bar status-success" : "status-bar status-error";
            console.log(`[状态] ${text}`);
        }

        // 页面加载完成后初始化
        $(document).ready(() => {
            initCharts();
            fetchAllData();
            setInterval(fetchAllData, REFRESH_INTERVAL);
            bindShortcuts();
            // 币种选择框联动
            $("#instIdSelect").change(() => {
                currentInstId = $("#instIdSelect").val();
                fetchAllData();
            });
            // 加载本地保存的持仓记录
            loadAllPositionRecords();
        });

        // 初始化图表
        function initCharts() {
            // K线图
            btcChart = echarts.init(document.getElementById("btc-chart"), null, { renderer: 'canvas' });
            btcChart.setOption({
                backgroundColor: "#1a1a1a",
                tooltip: { trigger: "axis", textStyle: { color: "#fff" } },
                grid: { left: "10%", right: "5%", top: "10%", bottom: "15%" },
                xAxis: { type: "category", axisLine: { lineStyle: { color: "#444" } }, axisLabel: { color: "#ccc", fontSize: 10 } },
                yAxis: { type: "value", axisLine: { lineStyle: { color: "#444" } }, axisLabel: { color: "#ccc", fontSize: 10 }, scale: true },
                series: [{ type: "candlestick", data: [], itemStyle: { color: "#ff4d4f", color0: "#52c41a", borderColor: "#ff4d4f", borderColor0: "#52c41a" } }]
            });

            // 深度图
            depthChart = echarts.init(document.getElementById("depth-chart"), null, { renderer: 'canvas' });
            depthChart.setOption({
                backgroundColor: "#1a1a1a",
                tooltip: { trigger: "item", textStyle: { color: "#fff" } },
                grid: { left: "15%", right: "5%", top: "10%", bottom: "10%" },
                xAxis: { type: "value", axisLine: { lineStyle: { color: "#444" } }, axisLabel: { color: "#ccc", fontSize: 10 } },
                yAxis: { type: "category", axisLine: { lineStyle: { color: "#444" } }, axisLabel: { color: "#ccc", fontSize: 10 } },
                series: [{ name: "卖盘(ASK)", type: "bar", data: [], itemStyle: { color: "#ff4d4f" } }, { name: "买盘(BID)", type: "bar", data: [], itemStyle: { color: "#52c41a" } }]
            });
        }

        // 拉取所有数据（修复报错和深度图加载问题）
        function fetchAllData() {
            updateStatus(`正在拉取${currentInstId}行情数据...`, false);
            // 分别处理每个接口，避免一个失败导致全部报错
            fetchKlineData().catch(err => console.log("K线拉取失败：", err.message || err));
            fetchTickerData().catch(err => console.log("最新价拉取失败：", err.message || err));
            fetchDepthData().catch(err => {
                console.log("深度图拉取失败：", err.message || err);
                // 深度图加载失败时显示最新买卖一价
                $.get(`${API_BASE_URL}/ticker`, { instId: currentInstId }, (res) => {
                    if (res.code === "0") {
                        const bid = res.data[0].bid; // 买一价
                        const ask = res.data[0].ask; // 卖一价
                        depthChart.setOption({
                            title: { 
                                text: `卖一：${ask} USDT\n买一：${bid} USDT`, 
                                left: "center", 
                                top: "40%",
                                textStyle: { color: "#fff", fontSize: 14 } 
                            },
                            series: [{ data: [] }, { data: [] }]
                        });
                    } else {
                        depthChart.setOption({
                            title: { 
                                text: "深度数据加载失败（移动端网络限制）", 
                                left: "center", 
                                top: "40%",
                                textStyle: { color: "#999", fontSize: 12 } 
                            },
                            series: [{ data: [] }, { data: [] }]
                        });
                    }
                });
            });
            // 延迟判断整体状态
            setTimeout(() => {
                if (currentPrice > 0) {
                    updateStatus(`${currentInstId}数据刷新成功（每10秒自动更新）`, true);
                } else {
                    const errMsg = "行情接口访问失败，请使用手机自带浏览器打开";
                    updateStatus(errMsg, false);
                }
            }, 3000);
        }

        // 拉取K线数据
        function fetchKlineData() {
            return new Promise((resolve, reject) => {
                $.get(`${API_BASE_URL}/candles`, { instId: currentInstId, bar: "15m", limit: "10" }, (res) => {
                    if (res.code === "0" && res.data.length > 0) {
                        const klineData = res.data.map(item => {
                            const timeStr = new Date(parseInt(item[0])).toLocaleTimeString();
                            return [timeStr, item[1], item[4], item[3], item[2]];
                        }).reverse();
                        btcChart.setOption({ xAxis: { data: klineData.map(item => item[0]) }, series: [{ data: klineData.map(item => item.slice(1)) }] });
                        resolve();
                    } else { reject(new Error("K线数据为空")); }
                }).fail((err) => reject(err));
            });
        }

        // 拉取深度数据
        function fetchDepthData() {
            return new Promise((resolve, reject) => {
                $.get(`${API_BASE_URL}/depth`, { instId: currentInstId, sz: "5" }, (res) => {
                    if (res.code === "0" && res.data) {
                        const depth = res.data[0];
                        const asks = depth.asks.map(item => [item[1], `${item[0]} USDT`]).reverse();
                        const bids = depth.bids.map(item => [item[1], `${item[0]} USDT`]);
                        depthChart.setOption({ series: [{ data: asks }, { data: bids }] });
                        resolve();
                    } else { reject(new Error("深度数据为空")); }
                }).fail((err) => reject(err));
            });
        }

        // 拉取最新成交价（用于盈亏计算）
        function fetchTickerData() {
            return new Promise((resolve, reject) => {
                $.get(`${API_BASE_URL}/ticker`, { instId: currentInstId }, (res) => {
                    if (res.code === "0" && res.data.length > 0) {
                        currentPrice = parseFloat(res.data[0].last); // 存储当前最新价
                        resolve();
                    } else { reject(new Error("最新价获取失败")); }
                }).fail((err) => reject(err));
            });
        }

        // 计算持仓盈亏
        function calculateProfit() {
            const instId = $("#instIdSelect").val();
            const direction = $("#directionSelect").val();
            const entryPrice = parseFloat($("#entryPrice").val());
            const positionAmt = parseFloat($("#positionAmt").val());

            // 校验输入
            if (isNaN(entryPrice) || isNaN(positionAmt) || entryPrice <= 0 || positionAmt <= 0) {
                alert("请输入有效的开仓价格和持仓数量！");
                return;
            }
            if (currentPrice === 0) {
                alert("当前价未加载完成，请稍等！");
                return;
            }

            // 计算盈亏
            let profit, profitRatio;
            if (direction === "long") {
                profit = (currentPrice - entryPrice) * positionAmt; // 做多盈亏
            } else {
                profit = (entryPrice - currentPrice) * positionAmt; // 做空盈亏
            }
            profitRatio = (profit / (entryPrice * positionAmt)) * 100; // 盈亏比例(%)

            // 渲染盈亏表格
            const profitClass = profit >= 0 ? "profit-green" : "profit-red";
            const html = `
                <tr>
                    <td>${instId}</td>
                    <td>${direction === "long" ? "做多" : "做空"}</td>
                    <td>${entryPrice.toFixed(2)}</td>
                    <td>${currentPrice.toFixed(2)}</td>
                    <td>${positionAmt.toFixed(3)}</td>
                    <td class="${profitClass}">${profit.toFixed(2)} USDT</td>
                    <td class="${profitClass}">${profitRatio.toFixed(2)}%</td>
                </tr>
            `;
            $("#profitTableBody").html(html);
        }

        // ========== 本地持仓记录保存/加载/删除功能 ==========
        // 保存持仓记录到本地缓存
        function savePositionRecord() {
            const instId = $("#instIdSelect").val();
            const direction = $("#directionSelect").val();
            const entryPrice = parseFloat($("#entryPrice").val());
            const positionAmt = parseFloat($("#positionAmt").val());

            if (isNaN(entryPrice) || isNaN(positionAmt) || entryPrice <= 0 || positionAmt <= 0) {
                alert("请先输入有效的持仓信息！");
                return;
            }

            // 构造记录对象
            const record = {
                id: new Date().getTime(), // 唯一ID
                name: `${instId}-${direction === "long" ? "多" : "空"}`,
                instId: instId,
                direction: direction,
                entryPrice: entryPrice,
                positionAmt: positionAmt,
                createTime: new Date().toLocaleString()
            };

            // 从本地缓存获取现有记录
            let records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            records.push(record);
            // 保存到本地缓存
            localStorage.setItem(RECORD_KEY, JSON.stringify(records));
            // 刷新记录下拉框
            loadAllPositionRecords();
            alert(`持仓记录【${record.name}】保存成功！`);
        }

        // 加载所有本地持仓记录到下拉框
        function loadAllPositionRecords() {
            const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            const $select = $("#recordSelect");
            // 清空原有选项（保留默认项）
            $select.html('<option value="">请选择保存的记录</option>');
            // 添加记录选项
            records.forEach(record => {
                $select.append(`<option value="${record.id}">${record.name}（${record.createTime}）</option>`);
            });
        }

        // 加载选中的持仓记录到输入框
        function loadPositionRecord() {
            const recordId = $("#recordSelect").val();
            if (!recordId) return;

            const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            const record = records.find(item => item.id == recordId);
            if (record) {
                // 填充到输入框
                $("#instIdSelect").val(record.instId);
                $("#directionSelect").val(record.direction);
                $("#entryPrice").val(record.entryPrice);
                $("#positionAmt").val(record.positionAmt);
                // 自动计算盈亏
                calculateProfit();
                // 同步币种到行情监控
                currentInstId = record.instId;
                fetchAllData();
            }
        }

        // 删除选中的持仓记录
        function deletePositionRecord() {
            const recordId = $("#recordSelect").val();
            if (!recordId) {
                alert("请先选择要删除的持仓记录！");
                return;
            }

            if (confirm("确定要删除该持仓记录吗？删除后无法恢复！")) {
                let records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
                records = records.filter(item => item.id != recordId);
                // 保存修改后的记录
                localStorage.setItem(RECORD_KEY, JSON.stringify(records));
                // 刷新下拉框并清空输入
                loadAllPositionRecords();
                $("#entryPrice").val("");
                $("#positionAmt").val("");
                $("#profitTableBody").html('<tr><td colspan="7">请录入持仓信息并点击计算</td></tr>');
                alert("持仓记录删除成功！");
            }
        }

        // 绑定快捷键
        function bindShortcuts() {
            document.addEventListener("keydown", (e) => {
                if (e.key === "F1") {
                    const instIds = ["BTC-USDT", "ETH-USDT", "SOL-USDT"];
                    const currentIndex = instIds.indexOf(currentInstId);
                    currentInstId = instIds[(currentIndex + 1) % instIds.length];
                    $("#instIdSelect").val(currentInstId);
                    fetchAllData();
                    alert(`已切换至${currentInstId}行情监控`);
                }
                if (e.key === "F2") {
                    alert("策略运行中：\n1. GitHub Actions每30分钟执行AI分析\n2. 前端每10秒刷新行情数据\n3. 支持本地保存持仓记录，刷新不丢失");
                }
            });
        }
    </script>
</body>
</html>