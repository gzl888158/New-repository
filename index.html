<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>豆包搭档·合约工具【稳定更新版】</title>
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box;font-family: "Microsoft YaHei", sans-serif;}
        body {background-color: #121212;color: #fff;padding: 20px;}
        .header {text-align: center;margin-bottom: 20px;padding-bottom: 10px;border-bottom: 1px solid #333;}
        .header h1 {color: #27ae60;font-size: 28px;}
        .shortcut-tips {margin-top: 10px;font-size: 12px;color: #999;}
        /* 接口状态 */
        .api-status {
            text-align: center;margin-bottom: 15px;padding: 8px;border-radius: 4px;
            font-size: 12px;background-color: #1e1e1e;
        }
        .api-status span {margin: 0 8px;display: inline-block;}
        .api-online {color: #27ae60;}
        .api-offline {color: #e74c3c;}
        .api-loading {color: #f39c12;}
        /* 榜单区域 */
        .rank-container {
            background-color: #1e1e1e;border-radius: 8px;padding: 15px;margin-bottom: 20px;border: 1px solid #27ae60;
        }
        .rank-title {
            color: #f39c12;font-size: 18px;margin-bottom: 10px;display: flex;justify-content: space-between;align-items: center;
        }
        .rank-tabs {display: flex;gap: 10px;margin-bottom: 15px;}
        .rank-tab {
            padding: 6px 12px;background-color: #2c2c2c;border-radius: 4px;cursor: pointer;color: #ccc;
        }
        .rank-tab.active {background-color: #27ae60;color: #fff;}
        .rank-list {display: flex;gap: 15px;flex-wrap: wrap;}
        .rank-item {
            background-color: #2c2c2c;border-radius: 8px;padding: 15px;width: calc(33.33% - 15px);min-width: 200px;
        }
        .rank-num {
            font-size: 24px;font-weight: bold;color: #27ae60;margin-bottom: 8px;
        }
        .rank-coin {font-size: 18px;margin-bottom: 5px;}
        .rank-change {font-size: 14px;}
        .rank-change.rise {color: #e74c3c;}
        .rank-change.fall {color: #27ae60;}
        /* 分析报告 */
        .report-container {
            background-color: #1e1e1e;border-radius: 8px;padding: 15px;margin-bottom: 20px;border: 1px solid #3498db;
        }
        .report-title {color: #3498db;font-size: 18px;margin-bottom: 10px;}
        .report-content {
            background-color: #2c2c2c;padding: 10px;border-radius: 4px;min-height: 120px;line-height: 1.6;
        }
        /* 提醒记录 */
        .alert-record-container {
            background-color: #1e1e1e;border-radius: 8px;padding: 15px;margin-bottom: 20px;border: 1px solid #f39c12;
        }
        .alert-record-title {
            color: #f39c12;font-size: 18px;margin-bottom: 10px;display: flex;justify-content: space-between;align-items: center;
        }
        .alert-record-title button {
            background-color: #f39c12;color: white;border: none;padding: 4px 8px;border-radius: 4px;cursor: pointer;font-size: 12px;
        }
        .alert-record-list {
            padding: 10px;background-color: #2c2c2c;border-radius: 4px;max-height: 100px;overflow-y: auto;font-size: 12px;line-height: 1.6;
        }
        /* 刷新间隔设置 */
        .refresh-setting {
            background-color: #1e1e1e;border-radius: 8px;padding: 15px;margin-bottom: 20px;border: 1px solid #333;
        }
        .setting-title {color: #27ae60;font-size: 18px;margin-bottom: 10px;}
        .setting-form {display: flex;gap: 10px;align-items: center;}
        .setting-form input {
            flex: 1;padding: 8px;background-color: #2c2c2c;color: #fff;border: 1px solid #444;border-radius: 4px;
        }
        .setting-form button {
            background-color: #27ae60;color: #fff;border: none;padding: 8px 15px;border-radius: 4px;cursor: pointer;
        }
        .setting-tips {margin-top: 8px;font-size: 12px;color: #999;}
    </style>
</head>
<body>
    <div class="header">
        <h1>豆包搭档·合约工具【三榜TOP3+每日更新+AI分析】</h1>
        <div class="shortcut-tips">
            小白用法：看榜单→加监控→等信号→抄参数下单 | 五接口智能刷新 | 每日自动更新榜单
        </div>
    </div>

    <!-- 接口状态 -->
    <div class="api-status" id="api-status">
        <span>CoinGecko：<span class="api-loading">加载中</span></span>
        <span>Binance：<span class="api-loading">加载中</span></span>
        <span>KuCoin：<span class="api-loading">加载中</span></span>
        <span>Gate.io：<span class="api-loading">加载中</span></span>
        <span>CMC：<span class="api-loading">加载中</span></span>
        <span>当前使用：<span id="active-api">无</span></span>
    </div>

    <!-- 刷新间隔设置 -->
    <div class="refresh-setting">
        <div class="setting-title">行情刷新间隔设置（毫秒）</div>
        <div class="setting-form">
            <input type="number" id="refresh-interval" placeholder="输入间隔（默认3000=3秒）" value="3000" min="1000">
            <button onclick="updateRefreshInterval()">立即生效</button>
        </div>
        <div class="setting-tips">提示：最低1000毫秒，建议3000-5000毫秒，避免接口限流</div>
    </div>

    <!-- 欧易三榜TOP3 -->
    <div class="rank-container">
        <div class="rank-title">
            <span>欧易三榜TOP3（每日0点自动更新）</span>
            <span id="rank-update-time" style="font-size:12px;color:#999">上次更新：加载中</span>
        </div>
        <div class="rank-tabs">
            <div class="rank-tab active" onclick="switchRank('rise')">涨幅榜TOP3</div>
            <div class="rank-tab" onclick="switchRank('hot')">热门榜TOP3</div>
            <div class="rank-tab" onclick="switchRank('new')">新币榜TOP3</div>
        </div>
        <div class="rank-list" id="rank-list">
            <div class="rank-item"><div class="rank-num">1</div><div class="rank-coin">加载中</div><div class="rank-change">涨幅：--%</div></div>
            <div class="rank-item"><div class="rank-num">2</div><div class="rank-coin">加载中</div><div class="rank-change">涨幅：--%</div></div>
            <div class="rank-item"><div class="rank-num">3</div><div class="rank-coin">加载中</div><div class="rank-change">涨幅：--%</div></div>
        </div>
    </div>

    <!-- 每日行情分析报告 -->
    <div class="report-container">
        <div class="report-title">每日行情分析报告（自动生成）</div>
        <div class="report-content" id="report-content">
            正在加载今日行情分析...<br><br>
            小白提示：榜单TOP3的币种，优先关注，更容易出大行情！
        </div>
    </div>

    <!-- 价格提醒历史记录 -->
    <div class="alert-record-container">
        <div class="alert-record-title">
            <span>价格提醒历史记录</span>
            <button onclick="clearAlertRecord()">清空记录</button>
        </div>
        <div class="alert-record-list" id="alert-record-list">
            暂无提醒记录
        </div>
    </div>

    <script>
        // 配置项
        const config = {
            refreshInterval: 3000, // 默认3秒刷新
            apiTimeout: 5000, // 接口超时时间5秒
            rankTypes: ['rise', 'hot', 'new'], // 榜单类型
            currentRank: 'rise', // 当前显示榜单
            apiStatus: { cg: 'loading', binance: 'loading', kucoin: 'loading', gate: 'loading', cmc: 'loading' },
            priceCache: {}, // 价格缓存
            rankData: { rise: [], hot: [], new: [] }, // 榜单数据
            alertRecord: [] // 提醒记录
        };

        // 币种映射（欧易主流币种）
        const coinMap = {
            BTC: { cg: 'bitcoin', binance: 'BTCUSDT', kucoin: 'BTC-USDT', gate: 'BTC_USDT', cmc: '1' },
            ETH: { cg: 'ethereum', binance: 'ETHUSDT', kucoin: 'ETH-USDT', gate: 'ETH_USDT', cmc: '1027' },
            SOL: { cg: 'solana', binance: 'SOLUSDT', kucoin: 'SOL-USDT', gate: 'SOL_USDT', cmc: '5426' },
            APT: { cg: 'aptos', binance: 'APTUSDT', kucoin: 'APT-USDT', gate: 'APT_USDT', cmc: '24745' },
            ARB: { cg: 'arbitrum', binance: 'ARBUSDT', kucoin: 'ARB-USDT', gate: 'ARB_USDT', cmc: '23077' },
            ADA: { cg: 'cardano', binance: 'ADAUSDT', kucoin: 'ADA-USDT', gate: 'ADA_USDT', cmc: '2010' },
            DOT: { cg: 'polkadot', binance: 'DOTUSDT', kucoin: 'DOT-USDT', gate: 'DOT_USDT', cmc: '6636' },
            MATIC: { cg: 'polygon', binance: 'MATICUSDT', kucoin: 'MATIC-USDT', gate: 'MATIC_USDT', cmc: '3890' },
            AVAX: { cg: 'avalanche-2', binance: 'AVAXUSDT', kucoin: 'AVAX-USDT', gate: 'AVAX_USDT', cmc: '5805' }
        };

        // ========== 核心优化1：带超时的接口请求函数 ==========
        async function fetchWithTimeout(url, options = {}, timeout = config.apiTimeout) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, { ...options, signal: controller.signal });
                clearTimeout(id);
                return response.ok ? await response.json() : null;
            } catch (err) {
                clearTimeout(id);
                return null;
            }
        }

        // ========== 核心优化2：多接口数据拉取（带缓存+错误处理） ==========
        async function fetchAllApiData() {
            // 1. 拉取CoinGecko
            const cgData = await fetchWithTimeout('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,aptos,arbitrum&vs_currencies=usd&include_24hr_change=true');
            config.apiStatus.cg = cgData ? 'online' : 'offline';
            if (cgData) {
                for (const [cgId, data] of Object.entries(cgData)) {
                    const coin = Object.keys(coinMap).find(k => coinMap[k].cg === cgId);
                    if (coin) config.priceCache[coin] = { ...config.priceCache[coin], cgPrice: data.usd, cgChange: data.usd_24h_change };
                }
            }

            // 2. 拉取Binance
            const binanceData = await fetchWithTimeout('https://api.binance.com/api/v3/ticker/24hr?symbols=["BTCUSDT","ETHUSDT","SOLUSDT","APTUSDT","ARBUSDT"]');
            config.apiStatus.binance = binanceData ? 'online' : 'offline';
            if (binanceData) {
                binanceData.forEach(item => {
                    const coin = Object.keys(coinMap).find(k => coinMap[k].binance === item.symbol);
                    if (coin) config.priceCache[coin] = { ...config.priceCache[coin], binancePrice: item.lastPrice, binanceChange: item.priceChangePercent };
                });
            }

            // 3. 拉取KuCoin（简化版，仅取主流币）
            const kucoinData = await fetchWithTimeout('https://api.kucoin.com/api/v1/market/allTickers');
            config.apiStatus.kucoin = kucoinData ? 'online' : 'offline';
            if (kucoinData && kucoinData.data.tickers) {
                kucoinData.data.tickers.forEach(item => {
                    const coin = Object.keys(coinMap).find(k => coinMap[k].kucoin === item.symbol);
                    if (coin) config.priceCache[coin] = { ...config.priceCache[coin], kucoinPrice: item.last, kucoinChange: item.changeRate * 100 };
                });
            }

            // 4. 更新接口状态显示
            updateApiStatusUI();
            // 5. 生成榜单数据
            generateRankData();
            // 6. 生成分析报告
            generateReport();
        }

        // ========== 核心优化3：榜单数据生成（基于缓存，避免空数据） ==========
        function generateRankData() {
            // 整理涨幅数据
            const riseData = [];
            Object.keys(coinMap).forEach(coin => {
                const cache = config.priceCache[coin];
                if (!cache) return;
                // 取多个接口的平均涨幅
                const changes = [cache.cgChange, cache.binanceChange, cache.kucoinChange].filter(c => c !== undefined);
                const avgChange = changes.length ? (changes.reduce((a, b) => a + parseFloat(b), 0) / changes.length).toFixed(2) : '0';
                riseData.push({ coin, change: parseFloat(avgChange) });
            });

            // 涨幅榜（降序）
            config.rankData.rise = riseData.sort((a, b) => b.change - a.change).slice(0, 3);
            // 热门榜（固定BTC/ETH/SOL）
            config.rankData.hot = [{ coin: 'BTC', change: riseData.find(item => item.coin === 'BTC')?.change || 0 }, { coin: 'ETH', change: riseData.find(item => item.coin === 'ETH')?.change || 0 }, { coin: 'SOL', change: riseData.find(item => item.coin === 'SOL')?.change || 0 }];
            // 新币榜（固定APT/ARB/AVAX）
            config.rankData.new = [{ coin: 'APT', change: riseData.find(item => item.coin === 'APT')?.change || 0 }, { coin: 'ARB', change: riseData.find(item => item.coin === 'ARB')?.change || 0 }, { coin: 'AVAX', change: riseData.find(item => item.coin === 'AVAX')?.change || 0 }];

            // 更新榜单UI
            updateRankUI();
            // 更新最后更新时间
            document.getElementById('rank-update-time').textContent = `上次更新：${new Date().toLocaleTimeString()}`;
        }

        // ========== 核心优化4：AI分析报告生成（基于真实数据） ==========
        function generateReport() {
            const riseTop = config.rankData.rise[0];
            let report = '';
            if (riseTop) {
                report += `今日涨幅榜榜首：${riseTop.coin}，24h涨幅${riseTop.change}%。`;
                if (riseTop.change > 5) {
                    report += `该币种涨幅超5%，多头趋势强劲，小白可轻仓跟进开多！`;
                } else if (riseTop.change < -5) {
                    report += `该币种跌幅超5%，空头趋势明显，小白可轻仓跟进开空！`;
                } else {
                    report += `该币种涨跌幅度较小，处于震荡行情，小白建议观望！`;
                }
            } else {
                report = '暂无足够行情数据，无法生成分析报告。请检查网络或等待接口加载完成。';
            }
            report += '<br><br>小白提示：榜单TOP3的币种流动性高，操作时滑点更小，优先选择这些币种交易！';
            document.getElementById('report-content').innerHTML = report;
        }

        // ========== UI更新函数 ==========
        function updateApiStatusUI() {
            const apiStatusEl = document.getElementById('api-status');
            let activeApiCount = 0;
            let html = '';
            for (const [api, status] of Object.entries(config.apiStatus)) {
                const statusText = status === 'loading' ? '加载中' : status === 'online' ? '✅ 在线' : '❌ 离线';
                const className = status === 'loading' ? 'api-loading' : status === 'online' ? 'api-online' : 'api-offline';
                html += `<span>${api.toUpperCase()}：<span class="${className}">${statusText}</span></span>`;
                if (status === 'online') activeApiCount++;
            }
            html += `<span>当前使用：<span id="active-api">${activeApiCount > 0 ? `${activeApiCount}个接口` : '无'}</span></span>`;
            apiStatusEl.innerHTML = html;
        }

        function switchRank(type) {
            config.currentRank = type;
            document.querySelectorAll('.rank-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.rank-tab[onclick="switchRank('${type}')"]`).classList.add('active');
            updateRankUI();
        }

        function updateRankUI() {
            const rankList = document.getElementById('rank-list');
            const data = config.rankData[config.currentRank];
            let html = '';
            data.forEach((item, index) => {
                const changeClass = item.change >= 0 ? 'rise' : 'fall';
                const changeText = `涨幅：${item.change}%`;
                html += `
                    <div class="rank-item">
                        <div class="rank-num">${index + 1}</div>
                        <div class="rank-coin">${item.coin}-USDT</div>
                        <div class="rank-change ${changeClass}">${changeText}</div>
                    </div>
                `;
            });
            rankList.innerHTML = html;
        }

        function updateRefreshInterval() {
            const inputVal = parseInt(document.getElementById('refresh-interval').value) || 3000;
            config.refreshInterval = Math.max(inputVal, 1000);
            document.getElementById('refresh-interval').value = config.refreshInterval;
            // 重启定时器
            clearInterval(window.refreshTimer);
            startRefreshTimer();
            alert(`刷新间隔已更新为 ${config.refreshInterval} 毫秒！`);
        }

        function startRefreshTimer() {
            // 立即执行一次
            fetchAllApiData();
            // 定时执行
            window.refreshTimer = setInterval(fetchAllApiData, config.refreshInterval);
        }

        function clearAlertRecord() {
            config.alertRecord = [];
            document.getElementById('alert-record-list').textContent = '暂无提醒记录';
        }

        // 初始化
        window.onload = function() {
            updateApiStatusUI();
            startRefreshTimer();
        };
    </script>
</body>
</html>